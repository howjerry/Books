# dbt Migration in Action: 完整書籍結構

## 書籍狀態追蹤

**已完成**:
- ✅ 書籍架構設計
- ✅ 資料夾結構建立
- ✅ README.md

**進行中**:
- 🔄 前言與序言
- 🔄 第 1-14 章內容撰寫
- 🔄 附錄 A-D

**待處理**:
- 📅 技術審查
- 📅 編輯校對
- 📅 最終出版

---

## 完整目錄結構

### 前言部分 (Front Matter)

#### 關於本書
- 本書的誕生背景
- 為什麼選擇這個主題
- 本書的獨特之處
- 如何使用本書
- 代碼約定與排版說明

#### 序言 (Foreword)
- 由資深數據工程專家撰寫
- AI 在數據工程領域的影響
- 本書在產業中的定位

#### 致謝 (Acknowledgments)
- M3 公司數據基盤團隊
- 技術審查者
- Manning 編輯團隊
- 開源社群貢獻

---

## Part 1: 基礎篇 - 遷移挑戰與準備

### 第 1 章：大規模遷移的挑戰與 AI 協作新範式

**學習目標**:
- 理解大規模資料庫遷移的常見挑戰
- 認識 AI 協作在遷移專案中的價值
- 了解本書的實戰案例背景

**章節結構**:
1.1 **遷移專案的痛點** (2500 字)
   - 50 個 SQL 檔案的複雜性分析
   - 手動遷移的時間與錯誤成本
   - 團隊資源限制
   - 案例：M3 公司的實際挑戰

1.2 **傳統遷移方法的局限** (2000 字)
   - 純手動方式的風險
   - 腳本自動化的不足
   - 為何需要更聰明的方法

1.3 **AI 協作新範式** (3000 字)
   - Claude Code 在遷移中的角色
   - 「知識演進式」協作模式
   - 人機協作的最佳實踐
   - 圖表：AI 協作 vs 傳統方法對比

1.4 **本書的實戰旅程預覽** (2000 字)
   - 從失敗到成功的完整路徑
   - 你將建立的核心產出物
   - 預期的學習成果
   - 時間投資與收穫

1.5 **準備開始** (1500 字)
   - 閱讀建議
   - 環境準備檢查清單
   - 本書的使用方式

**核心產出物**:
- 遷移挑戰評估表
- AI 協作價值矩陣

**預估頁數**: 25-30 頁

---

### 第 2 章：認識 dbt 與 BigQuery 遷移目標

**學習目標**:
- 掌握 dbt 核心概念與架構
- 理解 BigQuery 的關鍵特性
- 了解遷移目標與成功標準

**章節結構**:
2.1 **dbt 核心概念** (3000 字)
   - dbt 是什麼？為何選擇 dbt？
   - Models、Sources、Tests、Documentation
   - dbt 專案結構
   - Jinja templating 基礎

2.2 **BigQuery 關鍵特性** (2500 字)
   - 表格類型：標準表、分區表、分片表
   - Schema 與約束
   - UDF (User-Defined Functions)
   - 成本優化考量

2.3 **從原始 SQL 到 dbt 的轉變** (3500 字)
   - 思維模式轉換
   - 關鍵差異對照
   - 範例：簡單 SQL 的 dbt 版本
   - 範例：複雜 SQL 的分解策略

2.4 **遷移成功標準** (2000 字)
   - 功能等價性
   - 性能基準
   - 可維護性提升
   - 團隊採用度

**核心產出物**:
- dbt 概念速查表
- SQL to dbt 轉換對照表
- 遷移成功檢查清單

**預估頁數**: 25-30 頁

---

### 第 3 章：環境設置與第一次嘗試

**學習目標**:
- 建立完整的開發環境
- 完成第一個 SQL 到 dbt 的轉換
- 從初次失敗中學習

**章節結構**:
3.1 **開發環境設置** (2500 字)
   - 安裝 dbt-bigquery
   - 配置 profiles.yml
   - 專案初始化
   - Claude Code 設置
   - 範例：完整環境配置

3.2 **第一次嘗試：簡單直接的請求** (3000 字)
   - 選擇第一個遷移目標：xxx.sql
   - 對 Claude 的初始請求：「請將 xxx.sql 轉換為 dbt」
   - 快速生成的結果
   - 範例：生成的 dbt 模型（第一版）

3.3 **發現問題** (3500 字)
   - 註解被刪除了
   - 邏輯被不必要地改寫
   - not null 限制遺失
   - Schema 描述不完整
   - 逐一修正的痛苦過程

3.4 **反思與頓悟** (2000 字)
   - 為何簡單提示詞不夠
   - 需要系統化的知識傳遞
   - 「手冊」的概念誕生
   - 決策：建立 Migration Playbook

**核心產出物**:
- 開發環境配置文件
- 第一次嘗試的完整記錄
- 問題分類清單

**預估頁數**: 25-30 頁

---

## Part 2: 核心技術篇 - 建立遷移系統

### 第 4 章：建立遷移手冊（Migration Playbook）

**學習目標**:
- 設計有效的 AI 協作手冊
- 建立第一版 Migration Playbook
- 理解知識結構化的重要性

**章節結構**:
4.1 **Migration Playbook 的設計原則** (2500 字)
   - 為何需要手冊？
   - 手冊的目標讀者：AI 助手
   - 關鍵設計原則
   - 結構化知識 vs 零散提示

4.2 **建立第一版手冊** (4000 字)
   - 核心章節規劃
   - 從第一次經驗提煉知識
   - 初版手冊結構（6 個章節）
   - 範例：完整的初版 Playbook

   ```markdown
   # dbt 模型遷移手冊 v1.0
   ## 1. 確認遷移來源的 SQL 檔案
   ## 2. 建立參照外部 schema 資料表的 sources 定義
   ## 3. 建立 dbt 模型的 SQL 檔案（每日完全更新資料表版）
   ## 4. 建立模型檔案時的注意事項
   ## 5. 建立 dbt 模型的 schema 檔案
   ## 6. 整體共通注意事項
   ```

4.3 **測試手冊：第二個 SQL 檔案** (3000 字)
   - 選擇 yyy.sql 進行測試
   - 使用手冊的提示詞
   - 結果改善分析
   - 仍然存在的小問題

4.4 **迭代改進機制** (2500 字)
   - 從錯誤到手冊更新的流程
   - 錯誤分類與記錄
   - 手冊版本控制
   - 團隊協作考量

**核心產出物**:
- Migration Playbook v1.0
- 手冊設計模板
- 迭代改進流程圖

**預估頁數**: 28-32 頁

---

### 第 5 章：每日完全更新資料表遷移模式

**學習目標**:
- 掌握最常見的遷移模式
- 理解完全更新表的 dbt 實作
- 建立可重用的模式範本

**章節結構**:
5.1 **完全更新模式概述** (2000 字)
   - 什麼是每日完全更新？
   - 適用場景
   - BigQuery 中的實作方式
   - dbt 中的對應策略

5.2 **原始 SQL 分析** (2500 字)
   - 典型的原始 SQL 結構
   - CREATE OR REPLACE TABLE 語法
   - SELECT 邏輯解析
   - 範例：完整的原始 SQL

5.3 **dbt 遷移實作** (4000 字)
   - 模型檔案建立（.sql）
   - materialization 配置
   - Sources 定義
   - Schema 檔案建立（.yml）
   - 範例：完整的 dbt 模型
   - 註解標記與說明 ‹1› ‹2› ‹3›

5.4 **Schema 與約束處理** (2500 字)
   - 欄位描述遷移
   - not null 約束處理
   - 數據類型對應
   - 範例：完整的 schema.yml

5.5 **讓 Claude 獨立作業** (2000 字)
   - 更新 Playbook 加入此模式
   - 測試 3-5 個類似檔案
   - 成功率分析
   - 常見錯誤與修正

**核心產出物**:
- 完全更新模式範本
- Sources 定義範例
- Schema 檔案範例

**預估頁數**: 30-35 頁

---

### 第 6 章：分區資料表（Partitioned Tables）遷移

**學習目標**:
- 理解 BigQuery 分區表特性
- 掌握分區表的 dbt 配置
- 處理時間分區與整數分區

**章節結構**:
6.1 **BigQuery 分區表基礎** (2500 字)
   - 分區表的優勢
   - 時間分區 vs 整數分區
   - 成本與性能考量
   - 範例：原始分區表 SQL

6.2 **時間分區表遷移** (3500 字)
   - 分區欄位識別
   - dbt partition_by 配置
   - 增量更新策略
   - 範例：完整遷移實作

6.3 **整數分區表遷移** (3000 字)
   - range 分區配置
   - 分區邊界設定
   - 範例：整數分區 dbt 模型

6.4 **分區表測試與驗證** (2000 字)
   - 分區結構驗證
   - 查詢性能測試
   - 成本分析

**核心產出物**:
- 分區表遷移範本
- 分區配置決策樹
- 驗證腳本

**預估頁數**: 25-30 頁

---

### 第 7 章：分片資料表（Sharded Tables）遷移

**學習目標**:
- 理解分片表的歷史與現狀
- 將分片表遷移為分區表
- 處理複雜的日期後綴邏輯

**章節結構**:
7.1 **分片表背景** (2000 字)
   - 為何使用分片表（歷史原因）
   - table_20230101, table_20230102 模式
   - 分片表的缺點
   - 遷移策略：分片 → 分區

7.2 **分片表邏輯分析** (3000 字)
   - 原始 SQL 的日期處理
   - 每日建立新表的邏輯
   - 範例：分片表原始 SQL

7.3 **遷移為分區表** (4000 字)
   - 轉換策略設計
   - 歷史數據處理
   - dbt incremental 配置
   - 範例：完整遷移實作
   - 註解說明：為何選擇這種方式 ‹1› ‹2› ‹3›

7.4 **回填歷史數據** (2000 字)
   - 回填腳本設計
   - 分批執行策略
   - 驗證完整性

**核心產出物**:
- 分片表遷移範本
- 回填腳本
- 遷移檢查清單

**預估頁數**: 25-30 頁

---

### 第 8 章：Schema、約束與 UDF 處理

**學習目標**:
- 完整遷移 Schema 定義與描述
- 處理各種約束條件
- 遷移 User-Defined Functions

**章節結構**:
8.1 **Schema 描述完整遷移** (3000 字)
   - 從 BigQuery 提取 Schema
   - 生成 dbt schema.yml
   - 欄位描述遷移腳本
   - 範例：自動化提取工具

8.2 **約束條件處理** (3000 字)
   - not null 約束
   - unique 約束
   - dbt tests 配置
   - 範例：完整的測試配置

8.3 **UDF 遷移策略** (3500 字)
   - BigQuery UDF 分析
   - dbt macros 轉換
   - 何時保留 UDF vs 轉為 macro
   - 範例：UDF 到 macro 的轉換

8.4 **複雜欄位類型** (2000 字)
   - STRUCT、ARRAY 處理
   - JSON 欄位
   - GEOGRAPHY 等特殊類型

**核心產出物**:
- Schema 提取腳本
- UDF 遷移範本
- 約束測試範例

**預估頁數**: 28-32 頁

---

## Part 3: 知識演進篇 - AI 學習與改進

### 第 9 章：知識迭代循環 - 從錯誤中學習

**學習目標**:
- 建立系統化的錯誤學習機制
- 追蹤 AI 能力成長
- 優化 Migration Playbook

**章節結構**:
9.1 **常見錯誤分類** (3000 字)
   - SQL 邏輯錯誤
   - Schema 不一致
   - Sources 定義遺漏
   - 範例：實際遇到的 10 種錯誤

9.2 **從錯誤到手冊更新** (4000 字)
   - 錯誤根因分析流程
   - 提煉可重用知識
   - 更新手冊的最佳實踐
   - 範例：完整的更新循環
   - 圖表：知識累積流程

9.3 **Playbook 演進歷程** (3500 字)
   - v1.0 到 v3.0 的變化
   - 新增章節分析
   - 內容豐富度對比
   - 範例：版本對比表

   ```
   初版（6 節） → 穩定版（13 節）
   - 新增：sources 定義遺漏檢查
   - 新增：分區資料表版
   - 新增：分片資料表版
   - 新增：自我審查
   - 擴充：共通注意事項（2x → 6x）
   ```

9.4 **量化 AI 成長** (2500 字)
   - 錯誤率下降曲線
   - 一次成功率提升
   - 遷移時間縮短
   - 圖表：績效指標儀表板

**核心產出物**:
- 錯誤分類表
- Playbook 版本歷史
- AI 成長指標儀表板

**預估頁數**: 30-35 頁

---

### 第 10 章：自我審查機制設計

**學習目標**:
- 設計有效的自我檢查流程
- 建立審查檢查清單
- 實現早期錯誤發現

**章節結構**:
10.1 **為何需要自我審查** (2000 字)
   - AI 的「疏忽」現象
   - 手冊讀取不完整的問題
   - 早期發現 vs 後期修正

10.2 **設計審查檢查清單** (3500 字)
   - 檢查項目設計原則
   - 分類：SQL 正確性、Schema 完整性、dbt 配置
   - 範例：完整的審查清單

   ```markdown
   ## 9. 自我審查

   ### SQL 邏輯檢查
   ‹1› - [ ] SELECT 欄位與原始 SQL 一致
   ‹2› - [ ] JOIN 類型未改變（INNER/LEFT/RIGHT/OUTER）
   ‹3› - [ ] WHERE 條件完整保留

   ### Schema 檢查
   ‹4› - [ ] 所有欄位都有 description
   ‹5› - [ ] not_null 約束正確遷移
   ‹6› - [ ] 欄位名稱與原始一致

   ### Sources 檢查
   ‹7› - [ ] 所有外部表都已定義在 sources
   ‹8› - [ ] ref() 和 source() 使用正確
   ```

10.3 **實施自我審查** (3000 字)
   - 在 Playbook 中的位置
   - 提示 Claude 進行審查的方式
   - 範例：實際審查過程記錄
   - 審查後發現並修正的錯誤

10.4 **審查效果評估** (2000 字)
   - 自動發現的錯誤比例
   - 時間成本 vs 收益
   - 持續優化審查項目

**核心產出物**:
- 自我審查檢查清單
- 審查流程圖
- 效果評估報告範本

**預估頁數**: 25-28 頁

---

### 第 11 章：疑難排解模式庫

**學習目標**:
- 建立系統化的疑難排解知識庫
- 處理複雜的邊緣案例
- 建立團隊共享的解決方案庫

**章節結構**:
11.1 **疑難排解章節的價值** (2000 字)
   - 常見問題的模式化
   - 減少重複搜尋時間
   - 團隊知識共享

11.2 **Sources 定義問題** (3000 字)
   - 問題：Sources 定義遺漏
   - 問題：database/schema 不正確
   - 問題：table name 拼寫錯誤
   - 範例：完整疑難排解流程

11.3 **SQL 邏輯問題** (3500 字)
   - 問題：OUTER JOIN 變成 INNER JOIN
   - 問題：ref() 誤用為 source()
   - 問題：欄位名稱不一致（CREATE vs SELECT）
   - 範例：每個問題的檢測與修正方法

11.4 **性能與成本問題** (2500 字)
   - 問題：分區裁剪失效
   - 問題：不必要的全表掃描
   - 優化建議與實作

11.5 **將疑難排解加入 Playbook** (2000 字)
   - 結構化呈現
   - 更新策略
   - 範例：最終版 Playbook 結構（13 節）

**核心產出物**:
- 疑難排解模式庫
- 常見問題 FAQ
- 最終版 Migration Playbook

**預估頁數**: 28-32 頁

---

## Part 4: 自動化與部署篇

### 第 12 章：自動化驗證流程

**學習目標**:
- 設計自動化驗證策略
- 實作資料一致性檢查
- 建立驗證報告系統

**章節結構**:
12.1 **驗證策略設計** (2500 字)
   - 為何需要自動化驗證
   - 驗證層次：語法、結構、數據
   - 驗證目標：無差異遷移

12.2 **結構驗證** (3000 字)
   - Schema 一致性檢查
   - 欄位類型驗證
   - 約束條件確認
   - 範例：驗證腳本（Python）

12.3 **數據一致性驗證** (4000 字)
   - Row count 比對
   - Sample data 比對
   - Checksum 驗證
   - 範例：完整驗證流程

   ```python
   # 數據一致性驗證腳本
   def validate_migration(original_table, dbt_model):
       ‹1› # Row count 驗證
       ‹2› # 關鍵欄位 checksum
       ‹3› # 隨機抽樣比對
       ‹4› # 生成驗證報告
   ```

12.4 **讓 Claude 執行驗證** (3000 字)
   - 將驗證流程加入 Playbook
   - 部署到 QA 環境
   - 啟動處理並檢查結果
   - 範例：Claude 自主驗證過程

12.5 **處理有差異的情況** (2500 字)
   - 差異原因分析（當前挑戰）
   - 調查策略
   - 未來改進方向

**核心產出物**:
- 驗證腳本庫
- 驗證報告範本
- QA 環境配置

**預估頁數**: 32-35 頁

---

### 第 13 章：QA 與生產環境部署

**學習目標**:
- 建立多環境部署策略
- 實作安全的部署流程
- 處理生產環境特殊需求

**章節結構**:
13.1 **多環境策略** (2500 字)
   - Development、QA、Production
   - dbt profiles 配置
   - 環境變數管理
   - 範例：完整環境配置

13.2 **QA 環境部署** (3000 字)
   - 部署前檢查清單
   - 部署腳本
   - 初次運行與監控
   - 範例：QA 部署流程

13.3 **生產環境準備** (3500 字)
   - 風險評估
   - 回滾計畫
   - 逐步切換策略（Blue-Green）
   - 範例：生產部署計畫

13.4 **監控與告警** (2500 字)
   - dbt run 監控
   - 數據品質監控
   - 告警配置
   - 範例：監控儀表板

13.5 **實際部署經驗** (2000 字)
   - M3 的 50 個模型部署
   - 遇到的問題與解決
   - 上線後的穩定性

**核心產出物**:
- 多環境配置範本
- 部署檢查清單
- 監控配置範例

**預估頁數**: 30-32 頁

---

### 第 14 章：團隊協作與知識資產化

**學習目標**:
- 在團隊中推廣 AI 協作模式
- 建立知識資產管理機制
- 持續改進與擴展

**章節結構**:
14.1 **知識資產化的價值** (2500 字)
   - Migration Playbook 作為資產
   - Git 版本控制
   - 團隊共享的好處
   - 案例：其他遷移專案的複用

14.2 **團隊協作模式** (3000 字)
   - 多人使用同一個 Playbook
   - Pull Request 審查機制
   - 知識貢獻流程
   - 範例：團隊工作流程圖

14.3 **Playbook 維護與演進** (3000 字)
   - 版本管理策略
   - 定期審查與更新
   - 新模式的加入
   - 範例：Playbook v4.0 規劃

14.4 **擴展到其他遷移場景** (3000 字)
   - Spark to dbt
   - Redshift to BigQuery
   - 自定義遷移模式
   - 範例：Playbook 模板化

14.5 **AI 協作的未來** (2000 字)
   - 技術演進方向
   - 更智能的協作模式
   - 產業影響與展望

14.6 **總結與下一步** (1500 字)
   - 本書核心回顧
   - 你已掌握的能力
   - 持續學習資源
   - 結語

**核心產出物**:
- 團隊協作指南
- Playbook 模板庫
- 擴展案例集

**預估頁數**: 32-35 頁

---

## 附錄

### 附錄 A：完整 Migration Playbook 範本

**內容**:
- 最終穩定版 Playbook 完整內容
- 包含所有 13 個章節
- 詳細的注意事項與範例
- 可直接複製使用的模板

**預估頁數**: 20-25 頁

---

### 附錄 B：dbt 與 SQL 語法對照表

**內容**:
- 常見 SQL 模式的 dbt 對應
- BigQuery 特有語法轉換
- Jinja 模板常用技巧
- 快速參考表格

**預估頁數**: 12-15 頁

---

### 附錄 C：常見錯誤與解決方案

**內容**:
- 50+ 常見錯誤案例
- 錯誤訊息解讀
- 逐步解決方案
- 預防措施

**預估頁數**: 15-20 頁

---

### 附錄 D：Claude Code 提示詞最佳實踐

**內容**:
- 有效提示詞設計原則
- 針對遷移任務的優化技巧
- 範例對照：好的 vs 不好的提示詞
- 進階技巧

**預估頁數**: 10-12 頁

---

## 書籍統計總覽

### 預估篇幅
- **總頁數**: 350-400 頁
- **總字數**: 120,000-140,000 字
- **程式碼範例**: 60+ 完整範例
- **圖表**: 30-35 個架構圖、流程圖、對比表

### 內容分布
- **Part 1 (基礎篇)**: 75-90 頁 (21%)
- **Part 2 (核心技術)**: 135-160 頁 (40%)
- **Part 3 (知識演進)**: 80-95 頁 (24%)
- **Part 4 (自動化部署)**: 90-100 頁 (26%)
- **附錄**: 55-70 頁 (16%)

### 代碼語言分布
- **SQL**: 45%
- **YAML (dbt config)**: 25%
- **Python**: 20%
- **Bash/Shell**: 10%

### 特色元素
- 💡 **最佳實踐**: 每章 3-5 個
- ⚠️ **常見陷阱**: 每章 2-4 個
- 🔍 **深入探討**: 每章 1-2 個
- ✅ **檢查點**: 每節 1 個
- 📝 **實戰練習**: 每章 2-3 個

---

## 教學方法

### Manning "in Action" 標準
- **實戰專案驅動**: M3 的 50 個 SQL 遷移貫穿全書
- **循序漸進**: 從失敗到成功的真實旅程
- **產出物導向**: 每章產出可重用的工具和模板
- **對話式語調**: 像導師一樣引導讀者

### 學習路徑
```
挑戰認知 → dbt 基礎 → 第一次嘗試（失敗）→ 建立手冊 →
核心遷移模式 → 知識演進 → 自動化驗證 → 生產部署 →
團隊擴展
```

### 實踐元素比例
- **理論講解**: 25%
- **實際操作與代碼**: 50%
- **案例分析**: 15%
- **練習與驗證**: 10%

---

## 技術審查計畫

### 審查者
- **dbt 專家**: 2 位
- **BigQuery 專家**: 1 位
- **AI/LLM 應用專家**: 1 位
- **數據工程實踐者**: 2 位

### 審查重點
- 技術準確性
- dbt 最佳實踐符合度
- AI 協作方法有效性
- 代碼可執行性
- 實際可應用性

---

## 出版時程（暫定）

- **2025-02**: 第 1-3 章完成
- **2025-03**: 第 4-8 章完成
- **2025-04**: 第 9-11 章完成
- **2025-05**: 第 12-14 章完成
- **2025-06**: 附錄完成
- **2025-07**: 技術審查
- **2025-08**: 編輯與修訂
- **2025-09**: MEAP (Manning Early Access Program) 發布
- **2026-Q1**: 正式出版

---

*這是一本基於真實實戰經驗的技術書籍，每一個案例、每一行代碼、每一個教訓都來自實際的生產環境。*

© 2025 Manning Publications
