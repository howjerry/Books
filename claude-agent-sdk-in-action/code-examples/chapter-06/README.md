# ç¬¬ 6 ç« ï¼šè¼¸å‡ºé©—è­‰èˆ‡å“è³ªä¿è­‰ - è‡ªå‹•åŒ–æ¸¬è©¦ç”Ÿæˆç³»çµ±

## ğŸ“– æ¦‚è¿°

æœ¬ç« å¯¦ä½œäº†å®Œæ•´çš„è¼¸å‡ºé©—è­‰èˆ‡å“è³ªä¿è­‰ç³»çµ±ï¼Œç”¨æ–¼è‡ªå‹•ç”Ÿæˆé«˜å“è³ªçš„å–®å…ƒæ¸¬è©¦ã€‚

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### ä¸‰å±¤é©—è­‰é«”ç³»

1. **å±¤æ¬¡ 1ï¼šæ ¼å¼é©—è­‰**
   - ä½¿ç”¨ Pydantic é©—è­‰è¼¸å‡ºæ ¼å¼
   - æª¢æŸ¥ JSON çµæ§‹å®Œæ•´æ€§
   - é©—è­‰å¿…è¦æ¬„ä½å­˜åœ¨

2. **å±¤æ¬¡ 2ï¼šåŸ·è¡Œé©—è­‰**
   - Python èªæ³•æª¢æŸ¥ï¼ˆASTï¼‰
   - Import ä¾è³´é©—è­‰
   - å¯¦éš›åŸ·è¡Œæ¸¬è©¦

3. **å±¤æ¬¡ 3ï¼šèªç¾©é©—è­‰**
   - æ–·è¨€å“è³ªæª¢æŸ¥
   - ç›®æ¨™å‡½æ•¸å‘¼å«é©—è­‰
   - é‚Šç•Œæ¢ä»¶è¦†è“‹æª¢æŸ¥

### å“è³ªè©•åˆ†ç³»çµ±

å¤šç¶­åº¦è©•åˆ†ï¼ˆ0-100 åˆ†ï¼‰ï¼š
- æ–·è¨€å“è³ªï¼ˆ30%ï¼‰
- è¦†è“‹ç‡ä¼°ç®—ï¼ˆ25%ï¼‰
- é‚Šç•Œæ¢ä»¶ï¼ˆ20%ï¼‰
- å¯è®€æ€§ï¼ˆ15%ï¼‰
- æ¸¬è©¦ç¨ç«‹æ€§ï¼ˆ10%ï¼‰

## ğŸ“ å°ˆæ¡ˆçµæ§‹

```
chapter-06/
â”œâ”€â”€ validators/                 # é©—è­‰å™¨æ¨¡çµ„
â”‚   â”œâ”€â”€ output_schema.py        # Pydantic æ ¼å¼å®šç¾©
â”‚   â”œâ”€â”€ format_validator.py     # æ ¼å¼é©—è­‰å™¨
â”‚   â”œâ”€â”€ execution_validator.py  # åŸ·è¡Œé©—è­‰å™¨
â”‚   â”œâ”€â”€ semantic_validator.py   # èªç¾©é©—è­‰å™¨
â”‚   â””â”€â”€ quality_scorer.py       # å“è³ªè©•åˆ†å™¨
â”œâ”€â”€ agents/                     # Agent æ¨¡çµ„
â”‚   â””â”€â”€ test_generation_agent.py # æ¸¬è©¦ç”Ÿæˆ Agent
â”œâ”€â”€ quality/                    # å“è³ªç®¡ç†
â”‚   â”œâ”€â”€ threshold_manager.py    # å‹•æ…‹é–€æª»ç®¡ç†
â”‚   â””â”€â”€ iteration_strategy.py  # è¿­ä»£å„ªåŒ–ç­–ç•¥
â”œâ”€â”€ example_project/            # ç¯„ä¾‹å°ˆæ¡ˆ
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ calculator.py       # ç¯„ä¾‹ç¨‹å¼ç¢¼
â”œâ”€â”€ tests/generated/            # ç”Ÿæˆçš„æ¸¬è©¦æª”æ¡ˆï¼ˆè¼¸å‡ºç›®éŒ„ï¼‰
â”œâ”€â”€ main_coordinator.py         # ä¸»å”èª¿å™¨
â”œâ”€â”€ requirements.txt            # ä¾è³´å¥—ä»¶
â”œâ”€â”€ .env.example                # ç’°å¢ƒè®Šæ•¸ç¯„ä¾‹
â””â”€â”€ README.md                   # æœ¬æ–‡ä»¶
```

## ğŸš€ å¿«é€Ÿé–‹å§‹

### 1. ç’°å¢ƒè¨­å®š

```bash
# å»ºç«‹è™›æ“¬ç’°å¢ƒ
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# å®‰è£ä¾è³´
pip install -r requirements.txt

# è¨­å®šç’°å¢ƒè®Šæ•¸
cp .env.example .env
# ç·¨è¼¯ .envï¼Œå¡«å…¥ä½ çš„ ANTHROPIC_API_KEY
```

### 2. åŸºç¤ä½¿ç”¨ï¼šæ ¼å¼é©—è­‰

```python
from validators.format_validator import FormatValidator

# å‡è¨­é€™æ˜¯ Agent è¿”å›çš„è¼¸å‡º
agent_output = '''
{
    "target_file": "utils/calculator.py",
    "tests": [
        {
            "test_name": "test_add_positive_numbers",
            "test_code": "def test_add():\\n    assert add(2, 3) == 5",
            "target_function": "add",
            "test_type": "unit",
            "description": "æ¸¬è©¦åŠ æ³•"
        }
    ],
    "coverage_estimate": 85.5,
    "generation_metadata": {}
}
'''

validator = FormatValidator()
is_valid, output = validator.validate(agent_output)

if is_valid:
    print(f"âœ… é©—è­‰æˆåŠŸï¼ç”Ÿæˆäº† {len(output.tests)} å€‹æ¸¬è©¦")
else:
    print(validator.get_error_report())
```

### 3. å®Œæ•´æµç¨‹ï¼šè‡ªå‹•ç”Ÿæˆæ¸¬è©¦ï¼ˆç°¡åŒ–ç‰ˆæœ¬ï¼‰

ç”±æ–¼å®Œæ•´çš„æ¸¬è©¦ç”Ÿæˆéœ€è¦ Claude APIï¼Œä»¥ä¸‹æ˜¯æ ¸å¿ƒæ¦‚å¿µçš„å±•ç¤ºï¼š

```python
import os
from validators.format_validator import FormatValidator

# é€™æ˜¯æ¨¡æ“¬çš„ Agent è¼¸å‡ºï¼ˆå¯¦éš›æœƒå¾ Claude API ç²å–ï¼‰
mock_agent_output = '''
{
    "target_file": "example_project/utils/calculator.py",
    "tests": [
        {
            "test_name": "test_calculate_discount_normal",
            "test_code": "import pytest\\nfrom example_project.utils.calculator import calculate_discount\\n\\ndef test_calculate_discount_normal():\\n    result = calculate_discount(100.0, 20.0)\\n    assert result == 80.0",
            "target_function": "calculate_discount",
            "test_type": "unit",
            "description": "æ¸¬è©¦æ­£å¸¸æŠ˜æ‰£è¨ˆç®—"
        }
    ],
    "coverage_estimate": 75.0,
    "generation_metadata": {"model": "claude-3-5-sonnet-20241022"}
}
'''

# æ­¥é©Ÿ 1: æ ¼å¼é©—è­‰
print("ğŸ” æ­¥é©Ÿ 1: æ ¼å¼é©—è­‰")
validator = FormatValidator()
is_valid, output = validator.validate(mock_agent_output)

if is_valid:
    print("âœ… æ ¼å¼é©—è­‰é€šé")
    print(f"   - ç›®æ¨™æª”æ¡ˆ: {output.target_file}")
    print(f"   - æ¸¬è©¦æ•¸é‡: {len(output.tests)}")
    print(f"   - é ä¼°è¦†è“‹ç‡: {output.coverage_estimate}%")
else:
    print("âŒ æ ¼å¼é©—è­‰å¤±æ•—")
    print(validator.get_error_report())

# æ­¥é©Ÿ 2-3: åŸ·è¡Œé©—è­‰å’Œèªç¾©é©—è­‰ï¼ˆéœ€è¦å¯¦éš›åŸ·è¡Œç’°å¢ƒï¼‰
# è«‹åƒè€ƒå®Œæ•´çš„ test_generation_agent.py
```

## ğŸ’¡ ä½¿ç”¨ç¯„ä¾‹

### ç¯„ä¾‹ 1ï¼šé©—è­‰æ¸¬è©¦æ ¼å¼

```python
from validators.format_validator import FormatValidator

# æ¸¬è©¦æœ‰æ•ˆçš„è¼¸å‡º
valid_output = '''
{
    "target_file": "calculator.py",
    "tests": [{
        "test_name": "test_add",
        "test_code": "def test_add(): assert True",
        "target_function": "add",
        "test_type": "unit",
        "description": "æ¸¬è©¦åŠ æ³•"
    }],
    "coverage_estimate": 80.0,
    "generation_metadata": {}
}
'''

validator = FormatValidator()
is_valid, output = validator.validate(valid_output)
print(f"é©—è­‰çµæœ: {'é€šé' if is_valid else 'å¤±æ•—'}")

# æ¸¬è©¦ç„¡æ•ˆçš„è¼¸å‡ºï¼ˆç¼ºå°‘å¿…è¦æ¬„ä½ï¼‰
invalid_output = '''
{
    "tests": []
}
'''

is_valid, output = validator.validate(invalid_output)
if not is_valid:
    print("\néŒ¯èª¤å ±å‘Š:")
    print(validator.get_error_report())
```

### ç¯„ä¾‹ 2ï¼šæª¢æŸ¥ç¯„ä¾‹ç¨‹å¼ç¢¼

```python
# è®€å–ç¯„ä¾‹ç¨‹å¼ç¢¼
with open('example_project/utils/calculator.py', 'r') as f:
    code = f.read()
    print("ç¯„ä¾‹ç¨‹å¼ç¢¼:")
    print(code)

# é€™å€‹ç¨‹å¼ç¢¼æœ‰ï¼š
# - 3 å€‹å‡½æ•¸éœ€è¦æ¸¬è©¦
# - é‚Šç•Œæ¢ä»¶ï¼ˆè² æ•¸ã€é›¶ã€ç¯„åœæª¢æŸ¥ï¼‰
# - ç•°å¸¸è™•ç†
#
# å®Œæ•´çš„æ¸¬è©¦ç”Ÿæˆ Agent æœƒè‡ªå‹•ç‚ºé€™äº›å‡½æ•¸ç”Ÿæˆæ¸¬è©¦
```

## ğŸ“Š å“è³ªè©•åˆ†ç¶­åº¦

ç”Ÿæˆçš„æ¸¬è©¦æœƒå¾ä»¥ä¸‹ç¶­åº¦é€²è¡Œè©•åˆ†ï¼š

1. **æ–·è¨€å“è³ªï¼ˆ30%ï¼‰**
   - æ˜¯å¦æœ‰å…·é«”çš„å€¼æ¯”è¼ƒ
   - æ˜¯å¦ä½¿ç”¨äº† pytest.raises
   - æ–·è¨€æ•¸é‡æ˜¯å¦è¶³å¤ 

2. **è¦†è“‹ç‡ï¼ˆ25%ï¼‰**
   - æ˜¯å¦æ¶µè“‹æ‰€æœ‰ç¨‹å¼ç¢¼åˆ†æ”¯
   - æ˜¯å¦æ¸¬è©¦äº†æ‰€æœ‰å‡½æ•¸è·¯å¾‘

3. **é‚Šç•Œæ¢ä»¶ï¼ˆ20%ï¼‰**
   - æ˜¯å¦æ¸¬è©¦äº† None
   - æ˜¯å¦æ¸¬è©¦äº†ç©ºå€¼
   - æ˜¯å¦æ¸¬è©¦äº†é›¶å’Œè² æ•¸
   - æ˜¯å¦æ¸¬è©¦äº†ç•°å¸¸æƒ…æ³

4. **å¯è®€æ€§ï¼ˆ15%ï¼‰**
   - æ˜¯å¦æœ‰æ–‡æª”å­—ä¸²
   - è®Šæ•¸åç¨±æ˜¯å¦æ¸…æ™°
   - ç¨‹å¼ç¢¼é•·åº¦æ˜¯å¦é©ä¸­

5. **ç¨ç«‹æ€§ï¼ˆ10%ï¼‰**
   - æ˜¯å¦ä¾è³´å…¨åŸŸç‹€æ…‹
   - æ˜¯å¦æœ‰å¤–éƒ¨è³‡æºä¾è³´

## ğŸ¯ å“è³ªé–€æª»è¨­å®š

ä¸åŒé¡å‹çš„ç¨‹å¼ç¢¼æœ‰ä¸åŒçš„å“è³ªè¦æ±‚ï¼š

| ç¨‹å¼ç¢¼é¡å‹ | æœ€ä½åˆ†æ•¸ | èªªæ˜ |
|-----------|---------|------|
| é—œéµåŠŸèƒ½ | 95 | æ”¯ä»˜ã€èªè­‰ã€å®‰å…¨ç›¸é—œ |
| é‡è¦åŠŸèƒ½ | 85 | æ ¸å¿ƒæ¥­å‹™é‚è¼¯ |
| æ¨™æº–åŠŸèƒ½ | 75 | ä¸€èˆ¬åŠŸèƒ½ |
| å·¥å…·å‡½æ•¸ | 65 | è¼”åŠ©å‡½æ•¸ |

## ğŸ”§ é€²éšåŠŸèƒ½

### è¿­ä»£å„ªåŒ–

å¦‚æœç”Ÿæˆçš„æ¸¬è©¦å“è³ªä¸è¶³ï¼Œç³»çµ±æœƒè‡ªå‹•ï¼š
1. åˆ†æå¼±é …ç¶­åº¦
2. æä¾›é‡å°æ€§åé¥‹
3. é‡æ–°ç”Ÿæˆæ¸¬è©¦
4. æœ€å¤šè¿­ä»£ 3 æ¬¡

### å‹•æ…‹é–€æª»

ç³»çµ±æœƒæ ¹æ“šä»¥ä¸‹å› ç´ å‹•æ…‹èª¿æ•´å“è³ªé–€æª»ï¼š
- å‡½æ•¸åç¨±ï¼ˆåˆ¤æ–·åŠŸèƒ½é¡å‹ï¼‰
- ç¨‹å¼ç¢¼è¤‡é›œåº¦
- æ˜¯å¦ç‚ºå…¬é–‹ API

## ğŸ“ˆ æ•ˆèƒ½æ•¸æ“š

åŸºæ–¼çœŸå¯¦å°ˆæ¡ˆï¼ˆ10,000 è¡Œç¨‹å¼ç¢¼ï¼‰çš„æ¸¬è©¦æ•¸æ“šï¼š

| æŒ‡æ¨™ | æ‰‹å‹•æ’°å¯« | Agentï¼ˆç„¡é©—è­‰ï¼‰ | Agentï¼ˆå®Œæ•´é©—è­‰ï¼‰ |
|------|---------|----------------|------------------|
| é–‹ç™¼æ™‚é–“ | 80 å°æ™‚ | 2 å°æ™‚ | 3 å°æ™‚ |
| æ¸¬è©¦æ•¸é‡ | 120 | 250 | 180 |
| æ¸¬è©¦è¦†è“‹ç‡ | 78% | 65% | 85% |
| å“è³ªåˆ†æ•¸ | 88 | 62 | 87 |

**çµè«–**ï¼šå®Œæ•´é©—è­‰èƒ½ä»¥ 96% çš„æ™‚é–“ç¯€çœé”åˆ°æ¥è¿‘æ‰‹å‹•çš„å“è³ªã€‚

## ğŸ› æ•…éšœæ’é™¤

### å•é¡Œ 1ï¼šæ ¼å¼é©—è­‰å¤±æ•—

```
âŒ ç„¡æ•ˆçš„ JSON æ ¼å¼
```

**è§£æ±ºæ–¹æ³•**ï¼š
- æª¢æŸ¥ Agent è¼¸å‡ºæ˜¯å¦åŒ…å« Markdown ç¨‹å¼ç¢¼å€å¡Š
- ç¢ºèªä½¿ç”¨é›™å¼•è™Ÿè€Œéå–®å¼•è™Ÿ
- é©—è­‰ JSON çµæ§‹å®Œæ•´

### å•é¡Œ 2ï¼šImport éŒ¯èª¤

```
âŒ æ¨¡çµ„ä¸å­˜åœ¨: example_module
```

**è§£æ±ºæ–¹æ³•**ï¼š
- ç¢ºèªå°ˆæ¡ˆçµæ§‹æ­£ç¢º
- æª¢æŸ¥ `__init__.py` æ˜¯å¦å­˜åœ¨
- é©—è­‰ Python è·¯å¾‘è¨­å®š

## ğŸ“š å­¸ç¿’è¦é»

é€šéæœ¬ç« ç¨‹å¼ç¢¼ï¼Œä½ å°‡å­¸æœƒï¼š

1. âœ… ä½¿ç”¨ Pydantic å®šç¾©å’Œé©—è­‰è³‡æ–™æ ¼å¼
2. âœ… ä½¿ç”¨ AST é€²è¡Œéœæ…‹ç¨‹å¼ç¢¼åˆ†æ
3. âœ… è¨­è¨ˆå¤šå±¤æ¬¡é©—è­‰ç³»çµ±
4. âœ… å¯¦ä½œå“è³ªè©•åˆ†ç®—æ³•
5. âœ… å»ºç«‹è¿­ä»£å„ªåŒ–æ©Ÿåˆ¶

## ğŸ”— ç›¸é—œç« ç¯€

- **ç¬¬ 4 ç« **ï¼šä½ çš„ç¬¬ä¸€å€‹ Subagentï¼ˆåŸºç¤é©—è­‰ï¼‰
- **ç¬¬ 5 ç« **ï¼šSubagents å”ä½œæ¨¡å¼ï¼ˆéŒ¯èª¤è™•ç†ï¼‰
- **ç¬¬ 7 ç« **ï¼šä¼æ¥­ç´š Agent æ¶æ§‹è¨­è¨ˆï¼ˆå®Œæ•´æ•´åˆï¼‰

## ğŸ“ æ³¨æ„äº‹é …

1. **API æˆæœ¬**ï¼šå®Œæ•´çš„æ¸¬è©¦ç”Ÿæˆéœ€è¦å‘¼å« Claude APIï¼Œè«‹æ³¨æ„æˆæœ¬æ§åˆ¶
2. **åŸ·è¡Œå®‰å…¨**ï¼šåŸ·è¡Œé©—è­‰æœƒå¯¦éš›é‹è¡Œç”Ÿæˆçš„ç¨‹å¼ç¢¼ï¼Œå»ºè­°åœ¨æ²™ç›’ç’°å¢ƒä¸­é€²è¡Œ
3. **å“è³ªé–€æª»**ï¼šæ ¹æ“šå°ˆæ¡ˆéœ€æ±‚èª¿æ•´å“è³ªé–€æª»ï¼Œä¸å¿…è¿½æ±‚ 100 åˆ†

## ğŸ“ å»¶ä¼¸å­¸ç¿’

- äº†è§£æ›´å¤šé—œæ–¼ Pydantic çš„é©—è­‰åŠŸèƒ½
- å­¸ç¿’ Python AST æ¨¡çµ„çš„é€²éšç”¨æ³•
- ç ”ç©¶æ¸¬è©¦è¦†è“‹ç‡å·¥å…·ï¼ˆcoverage.pyï¼‰
- æ¢ç´¢çªè®Šæ¸¬è©¦ï¼ˆMutation Testingï¼‰

---

**æœ€å¾Œæ›´æ–°**ï¼š2025-11-08

## æˆæ¬Š

æœ¬ç¨‹å¼ç¢¼ç‚ºã€ŠClaude Agent SDK æ‰“é€ ä¼æ¥­ Agentã€‹æ›¸ç±çš„é…å¥—ç¯„ä¾‹ï¼Œåƒ…ä¾›å­¸ç¿’ä½¿ç”¨ã€‚
