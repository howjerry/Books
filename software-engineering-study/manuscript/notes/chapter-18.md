# 第18章　軟體安全工程 — 學習筆記

> **狀態**：✅ 已完成
> **閱讀日期**：2025-12-27
> **教材位置**：[content/chapter-18.md](../content/chapter-18.md)

---

## 章前預測（5 分鐘）

### 這章應該回答什麼問題？

1. 軟體安全和其他品質屬性有什麼不同？
2. 常見的安全威脅有哪些？
3. 如何做威脅建模？
4. 安全編碼有哪些實踐？

### 我現在的理解是什麼？

閱讀前，我的理解：
- 安全 = 不被駭
- 安全是資安團隊的責任
- 用個好密碼就夠了

### 我遇過哪些相關痛點？

1. **SQL Injection**：曾經被攻擊過
2. **敏感資料外洩**：API Key 進版控
3. **安全不知從何做起**：感覺太複雜

---

## 本章一句話

> **安全必須在設計時就考慮，而非事後添加。使用 STRIDE 做威脅建模，遵循安全編碼原則，在 CI/CD 中整合安全測試。**

---

## 3 個關鍵概念

### 概念 1：CIA 三元組

**書中定義**：

| 目標 | 定義 | 威脅範例 |
|------|------|----------|
| **機密性** | 只有授權者能存取 | 資料外洩 |
| **完整性** | 資料未被篡改 | 資料竄改 |
| **可用性** | 需要時能使用 | DoS 攻擊 |

**我的理解**：

這是思考安全的框架。每當設計功能時，問自己：

| 問題 | 對應目標 |
|------|----------|
| 誰可以看這個資料？ | 機密性 |
| 怎麼確保資料沒被改？ | 完整性 |
| 如果被攻擊還能用嗎？ | 可用性 |

**實際應用**：

| 功能 | C（機密） | I（完整） | A（可用） |
|------|-----------|-----------|-----------|
| 用戶密碼 | 雜湊儲存 | 強密碼規則 | 密碼重設 |
| 訂單資料 | 存取控制 | 簽章驗證 | 備份 |
| API | 認證 | 輸入驗證 | Rate Limit |

---

### 概念 2：STRIDE 威脅建模

**書中定義**：

| 威脅 | 說明 | 違反 |
|------|------|------|
| **S**poofing | 冒充身份 | 認證 |
| **T**ampering | 篡改資料 | 完整性 |
| **R**epudiation | 否認行為 | 不可否認 |
| **I**nformation Disclosure | 資訊洩漏 | 機密性 |
| **D**enial of Service | 拒絕服務 | 可用性 |
| **E**levation of Privilege | 權限提升 | 授權 |

**我的理解**：

STRIDE 是威脅的分類法，幫助系統性思考。

**使用方法**：

1. 畫出系統架構圖
2. 對每個元件問：「STRIDE 哪些適用？」
3. 評估風險並決定對策

**範例分析**：

| 元件 | S | T | R | I | D | E |
|------|---|---|---|---|---|---|
| 登入頁面 | ✓ | - | - | - | ✓ | - |
| API | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ |
| 資料庫 | - | ✓ | - | ✓ | ✓ | - |
| 管理後台 | ✓ | ✓ | ✓ | ✓ | - | ✓ |

---

### 概念 3：縱深防禦

**書中定義**：

多層防護，不依賴單一防線。

```
網路層 → 應用層 → 資料層 → 核心資產
```

**我的理解**：

「不要把雞蛋放在一個籃子裡」的安全版。

**實際層次**：

| 層次 | 防護措施 |
|------|----------|
| 網路 | 防火牆、WAF |
| 傳輸 | HTTPS、TLS |
| 應用 | 輸入驗證、輸出編碼 |
| 資料 | 加密、存取控制 |
| 監控 | 日誌、告警 |

**經驗法則**：
> 「假設每一層都可能被突破，所以每一層都要有防護。」

---

## 原則、方法、護欄

### 安全編碼速查表

| 威脅 | 防護 | 範例 |
|------|------|------|
| SQL Injection | 參數化查詢 | `cursor.execute(sql, (param,))` |
| XSS | 輸出編碼 | `escape(user_input)` |
| 弱密碼 | bcrypt 雜湊 | `bcrypt.hashpw()` |
| 敏感資料 | 環境變數 | `os.environ.get()` |
| 權限問題 | 每次檢查 | `if not authorized: deny()` |

---

### 護欄（Guardrail）

| 危險信號 | 可能的問題 | 修正方式 |
|----------|-----------|----------|
| 直接拼接 SQL | SQL Injection | 參數化查詢 |
| 直接輸出用戶輸入 | XSS | 輸出編碼 |
| 密碼用 MD5 | 弱雜湊 | 用 bcrypt |
| API Key 在程式碼 | 外洩風險 | 環境變數 |
| 只前端驗證 | 可被繞過 | 後端也驗證 |
| 錯誤顯示堆疊 | 資訊洩漏 | 通用錯誤訊息 |

---

## 1 個決策點

### 決策情境

**要做到什麼程度的安全？**

### 選項對比

| 層級 | 投入 | 適用 |
|------|------|------|
| 基本 | 低 | 內部工具 |
| 標準 | 中 | 一般 Web 應用 |
| 高度 | 高 | 金融、醫療 |

### 決策準則

**根據資料敏感度**：

| 資料類型 | 建議安全層級 |
|----------|--------------|
| 公開資料 | 基本 |
| 用戶帳號 | 標準 |
| 個資 | 標準+ |
| 財務資料 | 高度 |
| 醫療資料 | 高度 |

**經驗法則**：
> 「如果資料外洩會上新聞，就需要高度安全。」

---

## 1 個反模式（Anti-pattern）

### 反模式名稱

**「事後補安全」症候群**

### 錯誤做法

先開發完功能，再「補安全」：
- 「先上線，安全之後再說」
- 「功能趕完再加認證」
- 「有問題再修」

### 後果

1. **架構限制**：事後很難改
2. **成本高**：改動牽涉範圍大
3. **遺漏**：總有地方沒補到
4. **資安事件**：被攻擊才知道

### 正確做法

**Shift Left**：安全左移，越早越好。

| 階段 | 安全活動 |
|------|----------|
| 需求 | 安全需求 |
| 設計 | 威脅建模 |
| 編碼 | 安全編碼 |
| 測試 | 安全測試 |
| 部署 | 安全配置 |

**檢驗標準**：
> 「這個功能的安全設計文件在哪裡？」

---

## 可落地 Checklist（至少 5 條）

開發時檢查安全：

- [x] **輸入驗證**：所有輸入都驗證了嗎？（白名單）
- [x] **輸出編碼**：輸出有正確編碼嗎？（防 XSS）
- [x] **參數化查詢**：SQL 使用參數化嗎？（防注入）
- [x] **認證檢查**：每個 API 都檢查認證嗎？
- [x] **授權檢查**：每個操作都檢查權限嗎？
- [x] **敏感資料**：密碼用 bcrypt？Key 在環境變數？
- [x] **依賴掃描**：有檢查第三方套件漏洞嗎？
- [x] **錯誤處理**：錯誤訊息不洩漏敏感資訊嗎？

---

## 章後練習

### 練習：為你的專案做簡單威脅建模

> 目標：識別主要威脅和對策

**我的專案**：電商網站 API

**架構**：
```
用戶 → 前端 → API → 資料庫
                  ↓
              支付閘道
```

**STRIDE 分析**：

| 威脅 | 攻擊情境 | 風險 | 對策 |
|------|----------|------|------|
| S | 盜用帳號 | 高 | 多因素認證 |
| T | 竄改訂單金額 | 高 | 伺服器端驗證 |
| R | 否認下單 | 中 | 稽核日誌 |
| I | 洩漏客戶資料 | 高 | 加密 + 存取控制 |
| D | API 被打爆 | 中 | Rate Limiting |
| E | 普通用戶變管理員 | 高 | RBAC |

**優先處理**：
1. 認證強化（S）
2. 資料加密（I）
3. 權限控制（E）

---

## 延伸思考

### 安全和開發速度如何平衡？

**我的策略**：

1. **自動化**
   - 安全掃描自動化
   - 不增加人工負擔

2. **預設安全**
   - 用安全的框架
   - 預設配置是安全的

3. **分層處理**
   - 敏感功能：嚴格審查
   - 一般功能：自動掃描

4. **教育**
   - 開發者懂安全
   - 一開始就做對

**經驗法則**：
> 「自動化能處理 80% 的安全問題，剩下 20% 靠人工審查高風險部分。」

### 如何讓團隊重視安全？

**我的做法**：

1. **用案例說話**
   - 分享資安事件
   - 「這個公司被罰多少錢」

2. **降低門檻**
   - 提供工具
   - 提供 Checklist

3. **獎勵發現**
   - 內部 Bug Bounty
   - 鼓勵回報問題

4. **納入流程**
   - PR 必須通過安全掃描
   - 變成常規動作

---

## 完成確認

- [x] 完成章前預測
- [x] 讀完本章
- [x] 填寫本章一句話
- [x] 填寫 3 個關鍵概念
- [x] 填寫原則、方法、護欄
- [x] 填寫 1 個決策點
- [x] 填寫 1 個反模式
- [x] 填寫 Checklist
- [x] 完成章後練習
- [x] 完成延伸思考

**完成日期**：2025-12-27
