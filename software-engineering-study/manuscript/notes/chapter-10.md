# 第10章　架構設計的推薦方法 — 學習筆記

> **狀態**：✅ 已完成
> **閱讀日期**：2025-12-27
> **教材位置**：[content/chapter-10.md](../content/chapter-10.md)

---

## 章前預測（5 分鐘）

### 這章應該回答什麼問題？

1. 什麼是軟體架構？和設計有什麼不同？
2. 有哪些架構風格？如何選擇？
3. 如何設計架構？有什麼方法？
4. 如何記錄和評估架構？

### 我現在的理解是什麼？

閱讀前，我的理解：
- 架構就是畫系統圖
- 微服務比單體好
- 架構師畫完圖就交給開發

### 我遇過哪些相關痛點？

1. **沒人知道當初為什麼這樣設計**：問架構問題，沒人能回答
2. **過早微服務**：小專案用微服務，複雜度爆炸
3. **架構圖和實際不符**：畫的圖和程式碼不一樣

---

## 本章一句話

> **架構是關於重要且難以改變的決策。選擇架構風格要根據品質屬性需求，並用 ADR 記錄決策理由。**

---

## 3 個關鍵概念

### 概念 1：架構決策是難以改變的決策

**書中定義**：

架構 vs. 設計的區別：
- 架構：難以改變、影響範圍大
- 設計：較容易改變、影響局部

**判斷標準**：如果改變這個決策會影響很多地方，那是架構決策。

**我的理解**：

這個定義幫助我區分什麼值得花時間仔細思考：

| 決策類型 | 例子 | 改變成本 |
|----------|------|----------|
| 架構決策 | 選擇微服務 vs 單體 | 極高 |
| 架構決策 | 選擇資料庫類型 | 很高 |
| 設計決策 | 類別如何劃分 | 中等 |
| 實作決策 | 用哪個函式庫 | 較低 |

**經驗法則**：
- 架構決策值得開會討論、寫 ADR
- 設計決策可以 PR 討論
- 實作決策可以自己決定

---

### 概念 2：品質屬性驅動架構選擇

**書中定義**：

品質屬性是非功能需求，架構決定能達成什麼品質。

常見品質屬性：
- 效能、可用性、可擴展性
- 安全性、可維護性、可測試性

品質屬性之間有權衡。

**我的理解**：

以前我選架構的方式：「大家都用微服務，我們也用。」

正確的方式：
1. 確認品質屬性優先級（效能最重要？還是可維護性？）
2. 分析架構風格的特性
3. 選擇最符合需求的風格

**例子**：

| 優先品質 | 推薦架構 | 原因 |
|----------|----------|------|
| 快速開發 | 單體 | 簡單、快速 |
| 獨立部署 | 微服務 | 服務獨立 |
| 高吞吐 | 事件驅動 | 非同步處理 |
| 易理解 | 分層 | 結構清晰 |

**權衡例子**：
- 微服務 → 獨立部署 ↑，但複雜度 ↑
- 快取 → 效能 ↑，但一致性 ↓

---

### 概念 3：用 ADR 記錄架構決策

**書中定義**：

ADR（Architecture Decision Record）記錄：
- 情境：為什麼需要決策？
- 決策：選擇什麼？
- 理由：為什麼這樣選？
- 替代方案：考慮過什麼其他選項？
- 後果：這個決策帶來什麼影響？

**我的理解**：

ADR 解決了「沒人知道當初為什麼這樣設計」的問題。

**我以前的做法**：
- 開會討論 → 決定 → 忘記
- 新人問「為什麼？」→ 沒人記得

**應該的做法**：
- 開會討論 → 寫 ADR → 提交到程式碼庫
- 新人問「為什麼？」→ 看 ADR

**ADR 最佳實踐**：
1. 放在程式碼庫（`docs/adr/`）
2. 編號管理（ADR-001, ADR-002）
3. 只增不改（新決策寫新 ADR）
4. 簡潔（1-2 頁）
5. 記錄替代方案

---

## 原則、方法、護欄

### 架構風格選擇速查表

| 情境 | 推薦風格 | 原因 |
|------|----------|------|
| 小團隊、快速開發 | 單體 + 分層 | 簡單、快速 |
| 需要擴展部分功能 | 模組化單體 | 平衡簡單和靈活 |
| 多團隊、獨立部署 | 微服務 | 團隊自治 |
| 高吞吐、解耦 | 事件驅動 | 非同步處理 |
| 讀寫負載差異大 | CQRS | 讀寫分離優化 |

---

### 護欄（Guardrail）

| 危險信號 | 可能的問題 | 修正方式 |
|----------|-----------|----------|
| 小專案用微服務 | 過度設計 | 從單體開始 |
| 沒人知道為什麼這樣設計 | 缺少文件 | 開始寫 ADR |
| 架構圖和程式碼不符 | 文件過時 | C4 模型 + 自動生成 |
| 所有決策都是「架構決策」 | 過度謹慎 | 區分架構和設計 |
| 從不評估架構 | 技術債累積 | 定期架構審查 |

---

## 1 個決策點

### 決策情境

**單體 vs 微服務：什麼時候該用哪個？**

### 選項對比

| 面向 | 單體 | 微服務 |
|------|------|--------|
| 開發速度 | 快（初期） | 慢（初期），快（後期） |
| 部署 | 整體部署 | 獨立部署 |
| 擴展 | 整體擴展 | 按需擴展 |
| 複雜度 | 低（初期），高（後期） | 高（分散式複雜度） |
| 團隊 | 小團隊適合 | 多團隊適合 |
| 技術棧 | 統一 | 可多樣 |

### 決策準則

**選單體**：
- 團隊小（< 10 人）
- 專案初期、不確定方向
- 業務邏輯複雜但規模不大
- 沒有獨立擴展需求

**選微服務**：
- 多團隊（每個服務一個團隊）
- 需要獨立部署和擴展
- 已經有成熟的 DevOps 能力
- 業務邊界清晰

**經驗法則**：
> 「先單體，在痛的時候再拆。」
> 「微服務是解決方案，不是起點。」

---

## 1 個反模式（Anti-pattern）

### 反模式名稱

**「分散式單體」症候群**（Distributed Monolith）

### 錯誤做法

號稱微服務，但實際上：
- 服務之間緊密耦合
- 必須同時部署多個服務
- 共用資料庫
- 同步調用鏈太長

### 後果

1. **複雜度爆炸**：有分散式的複雜度，沒有微服務的好處
2. **部署困難**：改一個服務要部署多個
3. **偵錯困難**：問題分散在多個服務
4. **效能問題**：同步調用鏈太長

### 正確做法

1. **真正獨立**：服務可以獨立開發、測試、部署
2. **擁有資料**：每個服務擁有自己的資料
3. **非同步溝通**：優先使用事件，而非同步調用
4. **業務邊界**：按 bounded context 切分

**檢驗標準**：
> 「這個服務可以獨立運作嗎？」
> 「改這個服務需要同時改其他服務嗎？」

---

## 可落地 Checklist（至少 5 條）

架構設計時用這份清單：

- [x] **品質優先**：最重要的品質屬性是什麼？架構支持嗎？
- [x] **風格匹配**：架構風格適合專案規模和團隊嗎？
- [x] **權衡清楚**：這個決策的 trade-off 是什麼？
- [x] **ADR 記錄**：重要決策有記錄嗎？
- [x] **可演進**：架構可以隨需求演進嗎？
- [x] **不過度**：這是最簡單能滿足需求的架構嗎？
- [x] **團隊能力**：團隊有能力維護這個架構嗎？

---

## 章後練習

### 練習：為一個專案選擇架構風格

> 情境：電商平台，5 人團隊，預期 1 年後 10 人

**分析**：

| 維度 | 評估 |
|------|------|
| 團隊規模 | 小（5人），1年後中等（10人） |
| 品質優先 | 快速開發 > 可擴展性 |
| 業務複雜度 | 中等（訂單、商品、用戶） |
| 獨立部署需求 | 目前不需要 |
| DevOps 能力 | 初級 |

**決策**：

**初期（0-6個月）**：模組化單體
- 按領域分模組（User, Order, Product）
- 共用資料庫
- 整體部署

**中期（6-12個月）**：評估是否需要拆分
- 如果某個模組變化頻繁，考慮獨立服務
- 如果團隊變大，考慮按模組分團隊

**ADR 範例**：

```
# ADR-001: 選擇模組化單體架構

## 狀態
已接受

## 情境
5人團隊開發電商平台，預期1年後10人。

## 決策
採用模組化單體架構，按領域分模組。

## 理由
- 團隊小，單體更簡單
- 可以快速開發和迭代
- 模組化為未來拆分做準備

## 替代方案
- 微服務：團隊太小，複雜度過高
- 傳統單體：不便未來擴展

## 後果
- 初期開發快速
- 未來如需拆分，按模組邊界拆
```

---

## 延伸思考

### 你的團隊有記錄架構決策嗎？

**我的思考**：

我們目前沒有系統性記錄，成本包括：
1. 新人花很多時間理解「為什麼」
2. 重複討論已決定的事情
3. 重構時不知道當初的權衡

**改善計畫**：
1. 從現在開始寫 ADR
2. 重大決策必須有 ADR
3. 放在 `docs/adr/` 目錄
4. 新人 onboarding 必讀

### 如何避免「分散式單體」？

**我的策略**：

1. **先單體**：除非有明確理由，否則不拆
2. **清晰邊界**：即使單體，也按 bounded context 分模組
3. **擁有資料**：每個模組擁有自己的 table
4. **檢驗獨立性**：這個模組可以獨立部署嗎？
5. **非同步優先**：模組間用事件溝通

---

## 完成確認

- [x] 完成章前預測
- [x] 讀完本章
- [x] 填寫本章一句話
- [x] 填寫 3 個關鍵概念
- [x] 填寫原則、方法、護欄
- [x] 填寫 1 個決策點
- [x] 填寫 1 個反模式
- [x] 填寫 Checklist
- [x] 完成章後練習
- [x] 完成延伸思考

**完成日期**：2025-12-27
