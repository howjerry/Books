# 第10章　架構設計的推薦方法

> 「架構是關於重要的事情——不管那是什麼。架構決策是難以改變的決策。」
> — Martin Fowler

---

## 10.1 什麼是軟體架構？

### 10.1.1 架構的定義

**軟體架構**：系統的高層結構，包含軟體元件、元件之間的關係、以及指導設計和演進的原則。

架構關注：
- **元件**：系統由哪些主要部分組成？
- **連接**：這些部分如何互動？
- **約束**：有什麼限制和規則？
- **品質屬性**：如何達成非功能需求？

### 10.1.2 架構 vs. 設計

| 面向 | 架構 | 設計 |
|------|------|------|
| 範圍 | 系統全貌 | 可以是局部 |
| 決策影響 | 難以改變 | 較容易改變 |
| 關注點 | 品質屬性、結構 | 實作細節 |
| 抽象層次 | 高 | 低到高 |

**判斷標準**：如果改變這個決策會影響很多地方，那是架構決策。

### 10.1.3 為什麼架構重要？

| 原因 | 說明 |
|------|------|
| **品質屬性** | 架構決定能達成什麼品質 |
| **溝通** | 架構是團隊的共同語言 |
| **早期決策** | 架構決策影響深遠 |
| **風險管理** | 架構幫助識別和管理風險 |
| **成本估算** | 架構影響開發和維護成本 |

---

## 10.2 架構風格（Architectural Styles）

架構風格是解決特定問題的架構模式。

### 10.2.1 分層架構（Layered Architecture）

```
┌─────────────────────────────────────┐
│          展示層（Presentation）      │
├─────────────────────────────────────┤
│          業務層（Business）          │
├─────────────────────────────────────┤
│          持久層（Persistence）       │
├─────────────────────────────────────┤
│          資料庫層（Database）        │
└─────────────────────────────────────┘
```

**特點**：
- 每一層只依賴下一層
- 關注點分離
- 容易理解

**適用**：
- 傳統企業應用
- 團隊按層分工

**缺點**：
- 所有請求穿過所有層（效能）
- 可能導致「貧血領域模型」

### 10.2.2 微服務架構（Microservices）

```
┌─────────┐  ┌─────────┐  ┌─────────┐
│ 用戶服務 │  │ 訂單服務 │  │ 商品服務 │
└────┬────┘  └────┬────┘  └────┬────┘
     │            │            │
     └────────────┼────────────┘
                  │
          ┌───────┴───────┐
          │   API 閘道    │
          └───────────────┘
```

**特點**：
- 獨立部署
- 技術多樣性
- 團隊自治
- 故障隔離

**適用**：
- 大型系統
- 需要獨立擴展
- 多團隊開發

**缺點**：
- 分散式系統複雜度
- 運維成本高
- 資料一致性挑戰

### 10.2.3 事件驅動架構（Event-Driven）

```
┌─────────┐     ┌─────────────┐     ┌─────────┐
│ 生產者  │────►│  事件匯流排  │────►│ 消費者  │
└─────────┘     └─────────────┘     └─────────┘
                      │
                      ▼
                ┌─────────┐
                │ 消費者2 │
                └─────────┘
```

**特點**：
- 鬆耦合
- 非同步處理
- 可擴展

**適用**：
- 高吞吐量系統
- 需要解耦的系統
- 事件溯源

**缺點**：
- 偵錯困難
- 事件順序問題
- 最終一致性

### 10.2.4 其他常見風格

| 風格 | 特點 | 適用情境 |
|------|------|----------|
| **單體**（Monolith） | 所有功能在一個應用 | 小型專案、初期開發 |
| **客戶端-伺服器** | 前後端分離 | Web 應用 |
| **管道與過濾器** | 資料流處理 | 資料處理管線 |
| **發布-訂閱** | 訊息廣播 | 通知系統 |
| **CQRS** | 讀寫分離 | 高讀取負載 |

---

## 10.3 品質屬性（Quality Attributes）

### 10.3.1 什麼是品質屬性？

品質屬性是系統的非功能特性，架構決定能達成什麼品質。

常見品質屬性：

| 屬性 | 說明 | 度量例子 |
|------|------|----------|
| **效能** | 回應時間、吞吐量 | P99 < 200ms |
| **可用性** | 系統正常運作的時間 | 99.9% uptime |
| **可擴展性** | 處理增長負載的能力 | 支援 10x 用戶增長 |
| **安全性** | 防止未授權存取 | 通過滲透測試 |
| **可維護性** | 修改的容易程度 | 新功能 < 2 週 |
| **可測試性** | 測試的容易程度 | 覆蓋率 > 80% |

### 10.3.2 品質屬性場景

用場景來具體化品質屬性：

```
┌──────────────────────────────────────────────────┐
│                  品質屬性場景                     │
├──────────────────────────────────────────────────┤
│ 刺激來源：誰/什麼觸發？                           │
│ 刺激：什麼事件發生？                              │
│ 環境：系統處於什麼狀態？                          │
│ 製品：系統的哪個部分被影響？                      │
│ 回應：系統如何回應？                              │
│ 回應度量：如何度量回應？                          │
└──────────────────────────────────────────────────┘
```

**範例：效能場景**

| 元素 | 內容 |
|------|------|
| 刺激來源 | 1000 個並發用戶 |
| 刺激 | 發起搜尋請求 |
| 環境 | 正常運作 |
| 製品 | 搜尋服務 |
| 回應 | 返回搜尋結果 |
| 回應度量 | P99 延遲 < 500ms |

### 10.3.3 品質屬性權衡

品質屬性之間往往有權衡：

| 權衡 | 說明 |
|------|------|
| 效能 vs. 安全性 | 加密需要運算資源 |
| 可用性 vs. 一致性 | CAP 定理 |
| 可擴展性 vs. 簡單性 | 分散式增加複雜度 |
| 效能 vs. 可維護性 | 優化可能降低可讀性 |

**決策原則**：根據業務優先級做選擇，並記錄決策理由。

---

## 10.4 架構設計方法

### 10.4.1 ADD（Attribute-Driven Design）

**步驟**：

1. **確認需求**：功能需求、品質屬性、約束
2. **選擇要分解的元素**：從系統開始
3. **選擇設計概念**：架構風格、模式
4. **實例化元素**：具體化設計
5. **定義介面**：元件如何互動
6. **驗證**：設計是否滿足需求
7. **迭代**：對子元素重複步驟

### 10.4.2 架構評估：ATAM

**ATAM（Architecture Tradeoff Analysis Method）**：

```
┌─────────────────────────────────────────────────┐
│                    ATAM 流程                     │
├─────────────────────────────────────────────────┤
│ 1. 介紹 ATAM 方法                                │
│ 2. 介紹業務驅動因素                              │
│ 3. 介紹架構                                      │
│ 4. 識別架構方法                                  │
│ 5. 生成品質屬性效用樹                            │
│ 6. 分析架構方法                                  │
│ 7. 腦力激盪和優先排序場景                        │
│ 8. 分析架構方法（續）                            │
│ 9. 呈現結果                                      │
└─────────────────────────────────────────────────┘
```

**產出**：
- 敏感點（Sensitivity Points）
- 權衡點（Tradeoff Points）
- 風險（Risks）
- 非風險（Non-risks）

### 10.4.3 C4 模型

用四個層次描述架構：

```
Level 1: 系統情境圖（System Context）
    └── 系統和外部實體的關係

Level 2: 容器圖（Container）
    └── 系統內的主要容器（應用、資料庫）

Level 3: 元件圖（Component）
    └── 容器內的主要元件

Level 4: 程式碼（Code）
    └── 元件內的類別/函數
```

**範例：Level 2 容器圖**

```
┌─────────────────────────────────────────────────────────┐
│                        電商系統                          │
│                                                         │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐          │
│  │   Web    │    │   API    │    │  Worker  │          │
│  │  前端    │───►│  服務    │───►│  服務    │          │
│  └──────────┘    └────┬─────┘    └──────────┘          │
│                       │                                 │
│                       ▼                                 │
│                  ┌──────────┐                          │
│                  │ PostgreSQL│                          │
│                  │  資料庫   │                          │
│                  └──────────┘                          │
│                                                         │
└─────────────────────────────────────────────────────────┘
         ▲                                    │
         │                                    ▼
    ┌────┴─────┐                       ┌──────────┐
    │   用戶   │                       │ 第三方   │
    │          │                       │ 付款系統 │
    └──────────┘                       └──────────┘
```

---

## 10.5 架構決策記錄（ADR）

### 10.5.1 為什麼記錄架構決策？

- 新成員可以理解「為什麼這樣設計」
- 避免重複討論已決定的事情
- 提供重構時的參考
- 記錄權衡和替代方案

### 10.5.2 ADR 格式

```markdown
# ADR-001: 選擇 PostgreSQL 作為主資料庫

## 狀態
已接受

## 情境
我們需要選擇一個關聯式資料庫來儲存核心業務資料。

## 決策
我們將使用 PostgreSQL 作為主要資料庫。

## 理由
- 開源、成熟、社群活躍
- 支援 JSON 欄位，提供部分彈性
- 團隊有 PostgreSQL 經驗
- 雲端服務支援良好（AWS RDS、GCP Cloud SQL）

## 替代方案
- MySQL：也是選項，但 PostgreSQL 功能更豐富
- MongoDB：NoSQL，但我們的資料模型適合關聯式

## 後果
- 需要管理 PostgreSQL 實例
- 團隊需要熟悉 PostgreSQL 特性
- 未來如需切換，成本較高
```

### 10.5.3 ADR 最佳實踐

| 實踐 | 說明 |
|------|------|
| 放在程式碼庫 | 隨程式碼版本控制 |
| 編號管理 | ADR-001, ADR-002... |
| 只增不改 | 新決策寫新 ADR，舊的標記為「已取代」 |
| 簡潔 | 1-2 頁，不要太長 |
| 記錄替代方案 | 未來回顧時很有價值 |

---

## 10.6 架構模式

### 10.6.1 MVC（Model-View-Controller）

```
┌─────────┐     ┌─────────┐     ┌─────────┐
│  View   │◄────│Controller│────►│  Model  │
│  視圖   │     │ 控制器  │     │  模型   │
└────┬────┘     └─────────┘     └────┬────┘
     │                               │
     └───────────────────────────────┘
              用戶互動
```

**職責**：
- Model：資料和業務邏輯
- View：展示
- Controller：處理輸入，協調 Model 和 View

### 10.6.2 Repository 模式

```
┌─────────────┐     ┌──────────────┐     ┌─────────────┐
│   Service   │────►│  Repository  │────►│  Database   │
│   服務層    │     │   資料庫介面  │     │   資料庫    │
└─────────────┘     └──────────────┘     └─────────────┘
```

**好處**：
- 隔離資料存取邏輯
- 方便測試（可 mock Repository）
- 可以切換資料來源

### 10.6.3 API Gateway 模式

```
┌─────────┐
│  Client │
└────┬────┘
     │
     ▼
┌─────────────┐
│ API Gateway │
└──────┬──────┘
       │
   ┌───┼───┐
   ▼   ▼   ▼
┌───┐ ┌───┐ ┌───┐
│ A │ │ B │ │ C │
└───┘ └───┘ └───┘
  微服務
```

**職責**：
- 請求路由
- 認證授權
- 限流
- 負載平衡
- 日誌

### 10.6.4 Circuit Breaker 模式

```
     ┌─────────────────────────────────────┐
     │          Circuit Breaker            │
     │                                     │
     │  ┌─────────┐                       │
     │  │  Closed │◄──── 正常狀態          │
     │  └────┬────┘                       │
     │       │ 失敗超過閾值                │
     │       ▼                            │
     │  ┌─────────┐                       │
     │  │  Open   │◄──── 斷路狀態          │
     │  └────┬────┘                       │
     │       │ 超時後嘗試                  │
     │       ▼                            │
     │  ┌─────────┐                       │
     │  │Half-Open│◄──── 半開狀態          │
     │  └─────────┘                       │
     └─────────────────────────────────────┘
```

**用途**：防止連鎖失敗，快速失敗

---

## 10.7 本章總結

### 核心概念

| 概念 | 一句話解釋 |
|------|-----------|
| 軟體架構 | 系統的高層結構和指導原則 |
| 架構風格 | 解決特定問題的架構模式 |
| 品質屬性 | 系統的非功能特性 |
| ADD | 屬性驅動的架構設計方法 |
| C4 模型 | 四層次架構描述方法 |
| ADR | 架構決策記錄 |

### 架構風格選擇

| 情境 | 推薦風格 |
|------|----------|
| 小型專案、初期 | 單體 + 分層 |
| 中型、需要擴展 | 模組化單體 |
| 大型、多團隊 | 微服務 |
| 高吞吐、解耦 | 事件驅動 |
| 高讀取負載 | CQRS |

### 下一章預告

架構確定後，如何設計每個元件？下一章我們將學習「元件設計」——如何設計可重用、可維護的元件？

---

## 延伸思考

1. 你目前的系統是什麼架構風格？適合嗎？

2. 你的團隊有記錄架構決策嗎？不記錄的成本是什麼？

3. 如何在「過度設計」和「設計不足」之間取得平衡？

---

*下一章：第11章　元件設計*
