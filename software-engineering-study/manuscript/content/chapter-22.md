# 第22章　軟體組態管理

> 「如果你不能重現你的軟體是如何建構的，你就無法可靠地維護它。」

---

## 22.1 什麼是組態管理？

### 22.1.1 組態管理的定義

**軟體組態管理（Software Configuration Management, SCM）**：識別、組織和控制軟體修改的規範，確保每個版本都是可重現的。

組態管理回答的問題：

| 問題 | 答案 |
|------|------|
| 現在的版本是什麼？ | 版本控制 |
| 這個版本包含什麼？ | 基線管理 |
| 什麼時候改的？誰改的？ | 變更追蹤 |
| 怎麼建構這個版本？ | 建構管理 |
| 生產環境跑的是什麼版本？ | 發布管理 |

### 22.1.2 組態項目（Configuration Item）

**組態項目**：需要被管理的軟體工作產品。

| 類型 | 範例 |
|------|------|
| **原始碼** | .py, .js, .java |
| **配置檔** | .env, config.yaml |
| **文件** | README, API 文件 |
| **腳本** | Dockerfile, CI 腳本 |
| **依賴** | package.json, requirements.txt |
| **資料庫 Schema** | migrations |

### 22.1.3 組態管理的目標

| 目標 | 說明 |
|------|------|
| **識別** | 每個版本都能唯一識別 |
| **控制** | 變更經過授權和審查 |
| **審計** | 記錄誰、何時、改了什麼 |
| **重現** | 任何版本都能重新建構 |

---

## 22.2 版本控制

### 22.2.1 版本控制系統

| 世代 | 特徵 | 工具 |
|------|------|------|
| 第一代 | 本地版本 | RCS |
| 第二代 | 集中式 | SVN, CVS |
| 第三代 | 分散式 | Git, Mercurial |

### 22.2.2 Git 基本概念

```
┌──────────────────────────────────────────────────────────────┐
│                        Git 工作流                            │
│                                                              │
│  工作目錄        暫存區           本地倉庫        遠端倉庫   │
│  (Working)      (Staging)       (Local)        (Remote)     │
│                                                              │
│    ┌───┐  add    ┌───┐  commit  ┌───┐  push    ┌───┐       │
│    │   │────────►│   │─────────►│   │─────────►│   │       │
│    │   │         │   │          │   │          │   │       │
│    │   │◄────────│   │◄─────────│   │◄─────────│   │       │
│    └───┘ checkout└───┘  reset   └───┘  pull    └───┘       │
└──────────────────────────────────────────────────────────────┘
```

### 22.2.3 分支策略

**Git Flow**：

```
main ────────────────────────────────────────►
        ↑               ↑               ↑
release ├───────────────┤───────────────┤
        ↑               ↑               ↑
develop ├───────────────┴───────────────┤
        ↑       ↑       ↑       ↑       ↑
feature ├───────┤───────┤───────┤───────┤
```

| 分支 | 用途 |
|------|------|
| main | 生產就緒 |
| develop | 開發主線 |
| feature/* | 功能開發 |
| release/* | 發布準備 |
| hotfix/* | 緊急修復 |

**GitHub Flow**：

```
main ────────────────────────────────────────►
        ↑       ↑       ↑       ↑       ↑
feature ├───────┤───────┤───────┤───────┤
        PR      PR      PR      PR      PR
```

| 特點 | 說明 |
|------|------|
| 簡單 | 只有 main 和 feature |
| 持續部署 | main 永遠可部署 |
| PR 驅動 | 通過 PR 合併 |

### 22.2.4 策略選擇

| 情境 | 建議策略 |
|------|----------|
| 持續部署 | GitHub Flow |
| 定期發布 | Git Flow |
| 多版本維護 | Git Flow |
| 小團隊 | GitHub Flow |
| 大團隊 | Git Flow |

---

## 22.3 變更管理

### 22.3.1 變更控制流程

```
┌──────────────────────────────────────────────────────────────┐
│                     變更控制流程                              │
│                                                              │
│  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐ │
│  │  請求  │─►│  評估  │─►│  核准  │─►│  實施  │─►│  驗證  │ │
│  └────────┘  └────────┘  └────────┘  └────────┘  └────────┘ │
│                  │                                           │
│                  ▼                                           │
│              ┌────────┐                                      │
│              │  拒絕  │                                      │
│              └────────┘                                      │
└──────────────────────────────────────────────────────────────┘
```

### 22.3.2 變更請求內容

| 欄位 | 內容 |
|------|------|
| **ID** | 唯一識別碼 |
| **標題** | 簡短描述 |
| **描述** | 詳細說明 |
| **原因** | 為什麼要改 |
| **影響** | 影響範圍 |
| **優先級** | 緊急程度 |
| **狀態** | 請求、核准、進行中、完成 |

### 22.3.3 Pull Request 最佳實踐

| 實踐 | 說明 |
|------|------|
| **小 PR** | < 400 行，容易審查 |
| **清楚描述** | 說明改了什麼、為什麼 |
| **測試** | 附上測試 |
| **文件** | 更新相關文件 |
| **連結 Issue** | 關聯到需求或 Bug |

**PR 模板**：

```markdown
## 變更說明
<!-- 這個 PR 做了什麼？ -->

## 變更原因
<!-- 為什麼要這樣改？ -->

## 測試
- [ ] 單元測試通過
- [ ] 整合測試通過
- [ ] 手動測試過

## 影響
<!-- 這個變更影響什麼？ -->

## 相關 Issue
<!-- 關聯的 Issue -->
```

---

## 22.4 建構管理

### 22.4.1 建構自動化

**建構**：將原始碼轉換成可執行程式的過程。

| 語言 | 建構工具 |
|------|----------|
| Java | Maven, Gradle |
| JavaScript | npm, yarn |
| Python | pip, poetry |
| Go | go build |
| Rust | cargo |

### 22.4.2 CI/CD Pipeline

```
┌──────────────────────────────────────────────────────────────┐
│                      CI/CD Pipeline                          │
│                                                              │
│  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐ │
│  │  提交  │─►│  建構  │─►│  測試  │─►│  部署  │─►│  監控  │ │
│  └────────┘  └────────┘  └────────┘  └────────┘  └────────┘ │
│                                                              │
│      │           │           │           │           │       │
│      ▼           ▼           ▼           ▼           ▼       │
│   ┌──────┐   ┌──────┐   ┌──────┐   ┌──────┐   ┌──────┐    │
│   │ Lint │   │Build │   │Unit  │   │Deploy│   │Alert │    │
│   │Check │   │Image │   │Integ │   │Stage │   │      │    │
│   └──────┘   └──────┘   │E2E   │   │Prod  │   │      │    │
│                         └──────┘   └──────┘   └──────┘    │
└──────────────────────────────────────────────────────────────┘
```

### 22.4.3 可重現建構

| 原則 | 做法 |
|------|------|
| **鎖定依賴版本** | package-lock.json, requirements.txt |
| **固定基礎映像** | FROM node:18.17.0 |
| **隔離環境** | 使用容器 |
| **版本標記** | 每個建構都有版本 |

```dockerfile
# ✅ 可重現的 Dockerfile
FROM node:18.17.0-alpine

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .

ARG VERSION
ENV APP_VERSION=$VERSION

CMD ["node", "index.js"]
```

---

## 22.5 發布管理

### 22.5.1 版本號規範（Semantic Versioning）

```
MAJOR.MINOR.PATCH
  1  .  2  .  3
```

| 變更類型 | 說明 | 範例 |
|----------|------|------|
| MAJOR | 不相容變更 | 1.0.0 → 2.0.0 |
| MINOR | 新增功能（相容） | 1.0.0 → 1.1.0 |
| PATCH | Bug 修復 | 1.0.0 → 1.0.1 |

**Pre-release 版本**：
- 1.0.0-alpha.1
- 1.0.0-beta.2
- 1.0.0-rc.1

### 22.5.2 發布流程

```
┌──────────────────────────────────────────────────────────────┐
│                     發布流程                                  │
│                                                              │
│  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐ │
│  │ 準備   │─►│ 測試   │─►│ 建構   │─►│ 部署   │─►│ 驗證   │ │
│  │ Release│  │ Staging│  │ Artifact│ │ Prod  │  │ Smoke  │ │
│  └────────┘  └────────┘  └────────┘  └────────┘  └────────┘ │
│                                                              │
│      │           │           │           │           │       │
│      ▼           ▼           ▼           ▼           ▼       │
│   建立分支    完整測試     標記版本     漸進部署    監控指標   │
│   更新版號    修復問題     產生日誌     回滾機制    異常告警   │
└──────────────────────────────────────────────────────────────┘
```

### 22.5.3 部署策略

| 策略 | 說明 | 風險 |
|------|------|------|
| **Big Bang** | 一次全部替換 | 高 |
| **滾動部署** | 逐步替換 | 中 |
| **藍綠部署** | 兩套環境切換 | 低 |
| **金絲雀部署** | 小比例先上線 | 低 |

**金絲雀部署**：

```
       100% v1                    10% v2, 90% v1              100% v2
     ┌─────────┐                 ┌─────────┐                 ┌─────────┐
     │ v1 v1 v1│                 │ v2 v1 v1│                 │ v2 v2 v2│
     │ v1 v1 v1│       →         │ v1 v1 v1│       →         │ v2 v2 v2│
     │ v1 v1 v1│                 │ v1 v1 v1│                 │ v2 v2 v2│
     └─────────┘                 └─────────┘                 └─────────┘
       初始狀態                    先上 10%                    逐步擴大
```

---

## 22.6 環境配置管理

### 22.6.1 環境類型

| 環境 | 用途 | 配置 |
|------|------|------|
| **開發** | 本機開發 | 開發配置 |
| **測試** | 自動化測試 | 測試配置 |
| **Staging** | 類生產驗證 | 類生產配置 |
| **生產** | 正式運行 | 生產配置 |

### 22.6.2 配置管理原則

| 原則 | 說明 |
|------|------|
| **外部化** | 配置不進程式碼 |
| **環境變數** | 用環境變數注入 |
| **機密分離** | 機密用秘密管理 |
| **版本控制** | 配置也要版本控制 |

### 22.6.3 配置層次

```
┌──────────────────────────────────────────────────────────────┐
│                     配置優先級（高到低）                      │
│                                                              │
│  1. 環境變數                   DATABASE_URL=...              │
│  2. 配置檔（環境特定）         config.production.yaml        │
│  3. 配置檔（共用）             config.yaml                   │
│  4. 程式碼預設值               DATABASE_URL || 'localhost'   │
└──────────────────────────────────────────────────────────────┘
```

### 22.6.4 機密管理

| 工具 | 說明 |
|------|------|
| **HashiCorp Vault** | 專業機密管理 |
| **AWS Secrets Manager** | AWS 雲端機密 |
| **環境變數** | 簡單情境 |
| **Kubernetes Secrets** | K8s 機密 |

---

## 22.7 本章總結

### 核心概念

| 概念 | 一句話解釋 |
|------|-----------|
| 組態管理 | 控制軟體的變更 |
| 版本控制 | 追蹤原始碼歷史 |
| 分支策略 | 管理平行開發 |
| 語義版本 | 版本號有意義 |
| CI/CD | 自動化建構部署 |

### 組態管理 Checklist

| 項目 | 問題 |
|------|------|
| 版本控制 | 所有程式碼都在版控嗎？ |
| 分支策略 | 有明確的分支策略嗎？ |
| PR 審查 | 變更經過審查嗎？ |
| 自動建構 | 建構自動化了嗎？ |
| 可重現 | 能重新建構舊版本嗎？ |
| 配置分離 | 配置和程式碼分離嗎？ |
| 機密管理 | 機密安全儲存嗎？ |

### 下一章預告

管理軟體需要度量。下一章我們將學習「軟體度量與分析」——度量什麼、如何分析、如何使用。

---

## 延伸思考

1. 你的團隊用什麼分支策略？適合嗎？

2. 你能重新建構三個月前的版本嗎？

3. 你的機密是如何管理的？安全嗎？

---

*下一章：第23章　軟體度量與分析*
