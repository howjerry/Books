# 第18章　軟體安全工程

> 「安全不是功能，而是屬性。它必須在設計時就考慮，而非事後添加。」

---

## 18.1 什麼是軟體安全工程？

### 18.1.1 安全工程的定義

**軟體安全工程（Software Security Engineering）**：在軟體開發生命週期中系統性地內建安全的實踐。

安全 vs. 相關概念：

| 概念 | 定義 | 焦點 |
|------|------|------|
| **安全（Security）** | 防止惡意行為 | 對抗攻擊者 |
| **隱私（Privacy）** | 保護個人資料 | 資料控制 |
| **可靠性（Reliability）** | 正確運作 | 防止故障 |

### 18.1.2 CIA 三元組

安全的核心目標：

```
            機密性
           (Confidentiality)
              ╱╲
             ╱  ╲
            ╱    ╲
           ╱      ╲
          ╱   安全  ╲
         ╱          ╲
        ╱────────────╲
   完整性            可用性
(Integrity)      (Availability)
```

| 目標 | 定義 | 威脅範例 |
|------|------|----------|
| **機密性** | 只有授權者能存取 | 資料外洩 |
| **完整性** | 資料未被篡改 | 資料竄改 |
| **可用性** | 需要時能使用 | DoS 攻擊 |

### 18.1.3 安全開發生命週期（SDL）

```
┌──────────────────────────────────────────────────────────────────┐
│                  安全開發生命週期（SDL）                          │
│                                                                  │
│  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐    │
│  │  需求  │─►│  設計  │─►│  實作  │─►│  測試  │─►│  部署  │    │
│  └────────┘  └────────┘  └────────┘  └────────┘  └────────┘    │
│      │           │           │           │           │          │
│      ▼           ▼           ▼           ▼           ▼          │
│  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐    │
│  │安全需求│  │威脅建模│  │安全編碼│  │安全測試│  │安全配置│    │
│  └────────┘  └────────┘  └────────┘  └────────┘  └────────┘    │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

---

## 18.2 常見安全威脅

### 18.2.1 OWASP Top 10

| 排名 | 威脅 | 說明 |
|------|------|------|
| 1 | **Broken Access Control** | 存取控制失效 |
| 2 | **Cryptographic Failures** | 加密失敗 |
| 3 | **Injection** | 注入攻擊 |
| 4 | **Insecure Design** | 不安全設計 |
| 5 | **Security Misconfiguration** | 安全配置錯誤 |
| 6 | **Vulnerable Components** | 使用有漏洞元件 |
| 7 | **Authentication Failures** | 認證失敗 |
| 8 | **Data Integrity Failures** | 資料完整性問題 |
| 9 | **Logging Failures** | 日誌監控不足 |
| 10 | **SSRF** | 伺服器端請求偽造 |

### 18.2.2 注入攻擊

**SQL Injection 範例**：

```python
# ❌ 危險的寫法
query = f"SELECT * FROM users WHERE name = '{username}'"

# 攻擊者輸入：' OR '1'='1
# 結果查詢：SELECT * FROM users WHERE name = '' OR '1'='1'
# 會回傳所有用戶！
```

```python
# ✅ 安全的寫法（參數化查詢）
query = "SELECT * FROM users WHERE name = ?"
cursor.execute(query, (username,))
```

**其他注入類型**：

| 類型 | 攻擊向量 | 防護 |
|------|----------|------|
| SQL Injection | 資料庫查詢 | 參數化查詢 |
| XSS | HTML/JavaScript | 輸出編碼 |
| Command Injection | 系統命令 | 避免 shell 執行 |
| LDAP Injection | LDAP 查詢 | 輸入驗證 |

### 18.2.3 認證與授權漏洞

| 問題 | 說明 | 防護 |
|------|------|------|
| **弱密碼** | 可被猜測 | 密碼政策 |
| **Session 固定** | Session ID 可預測 | 登入後換 Session |
| **權限提升** | 低權限變高權限 | 最小權限原則 |
| **未授權存取** | 繞過存取控制 | 每個請求都檢查 |

---

## 18.3 威脅建模

### 18.3.1 什麼是威脅建模？

**威脅建模（Threat Modeling）**：系統性識別和評估威脅的過程。

**目的**：
- 理解系統的攻擊面
- 識別潛在威脅
- 決定防護優先級

### 18.3.2 STRIDE 模型

| 威脅 | 說明 | 違反的屬性 |
|------|------|-----------|
| **S**poofing | 冒充身份 | 認證 |
| **T**ampering | 篡改資料 | 完整性 |
| **R**epudiation | 否認行為 | 不可否認 |
| **I**nformation Disclosure | 資訊洩漏 | 機密性 |
| **D**enial of Service | 拒絕服務 | 可用性 |
| **E**levation of Privilege | 權限提升 | 授權 |

### 18.3.3 威脅建模流程

```
┌──────────────────────────────────────────────────────────────┐
│                    威脅建模流程                               │
│                                                              │
│  1. 識別資產    2. 繪製架構    3. 識別威脅    4. 評估風險    │
│  ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐     │
│  │什麼值得  │──►│系統如何  │──►│可能的   │──►│風險有   │     │
│  │保護？   │   │運作？   │   │攻擊？   │   │多大？   │     │
│  └─────────┘   └─────────┘   └─────────┘   └─────────┘     │
│                                                    │         │
│                                                    ▼         │
│                                            5. 決定對策       │
│                                            ┌─────────┐      │
│                                            │如何防護？│      │
│                                            └─────────┘      │
└──────────────────────────────────────────────────────────────┘
```

### 18.3.4 威脅建模範例

**場景**：電商網站

```
┌─────────────────────────────────────────────────────────────┐
│                      電商系統                                │
│                                                             │
│   ┌────────┐      ┌────────┐      ┌────────┐              │
│   │  用戶  │─────►│  Web   │─────►│  API   │              │
│   │ 瀏覽器 │      │ 前端   │      │ 後端   │              │
│   └────────┘      └────────┘      └────────┘              │
│                                        │                    │
│                        ┌───────────────┼────────────────┐  │
│                        │               │                │  │
│                        ▼               ▼                ▼  │
│                   ┌────────┐      ┌────────┐      ┌────────┐
│                   │ 資料庫 │      │ 支付   │      │ 第三方 │
│                   │        │      │ 閘道   │      │  API   │
│                   └────────┘      └────────┘      └────────┘
└─────────────────────────────────────────────────────────────┘
```

**STRIDE 分析**：

| 元素 | 威脅 | 風險 | 對策 |
|------|------|------|------|
| 用戶認證 | Spoofing | 高 | 多因素認證 |
| API 資料 | Tampering | 高 | 簽章驗證 |
| 訂單記錄 | Repudiation | 中 | 稽核日誌 |
| 客戶資料 | Information Disclosure | 高 | 加密 |
| API 端點 | DoS | 中 | Rate Limiting |
| 管理功能 | Elevation | 高 | RBAC |

---

## 18.4 安全設計原則

### 18.4.1 核心原則

| 原則 | 說明 |
|------|------|
| **最小權限** | 只給需要的權限 |
| **縱深防禦** | 多層防護 |
| **預設安全** | 預設是安全的 |
| **失敗安全** | 失敗時也要安全 |
| **分離關注** | 安全邏輯獨立 |
| **簡單化** | 簡單更安全 |

### 18.4.2 最小權限原則

```python
# ❌ 過度權限
class User:
    def __init__(self):
        self.permissions = ["read", "write", "delete", "admin"]

# ✅ 最小權限
class User:
    def __init__(self, role):
        self.permissions = self._get_permissions(role)

    def _get_permissions(self, role):
        if role == "reader":
            return ["read"]
        elif role == "editor":
            return ["read", "write"]
        elif role == "admin":
            return ["read", "write", "delete", "admin"]
```

### 18.4.3 縱深防禦

```
┌──────────────────────────────────────────────────────────────┐
│                     縱深防禦                                  │
│                                                              │
│   ┌────────────────────────────────────────────────────┐    │
│   │ 網路層：防火牆、WAF                                  │    │
│   │  ┌────────────────────────────────────────────┐   │    │
│   │  │ 應用層：輸入驗證、輸出編碼                    │   │    │
│   │  │  ┌────────────────────────────────────┐   │   │    │
│   │  │  │ 資料層：加密、存取控制                │   │   │    │
│   │  │  │  ┌────────────────────────────┐   │   │   │    │
│   │  │  │  │        核心資產             │   │   │   │    │
│   │  │  │  └────────────────────────────┘   │   │   │    │
│   │  │  └────────────────────────────────────┘   │   │    │
│   │  └────────────────────────────────────────────┘   │    │
│   └────────────────────────────────────────────────────┘    │
└──────────────────────────────────────────────────────────────┘
```

### 18.4.4 失敗安全

```python
# ❌ 失敗不安全
def authorize(user, resource):
    try:
        return check_permission(user, resource)
    except Exception:
        return True  # 出錯就允許 - 危險！

# ✅ 失敗安全
def authorize(user, resource):
    try:
        return check_permission(user, resource)
    except Exception:
        log.error("Authorization check failed")
        return False  # 出錯就拒絕 - 安全！
```

---

## 18.5 安全編碼實踐

### 18.5.1 輸入驗證

| 原則 | 說明 |
|------|------|
| **白名單** | 只接受已知好的 |
| **伺服器驗證** | 不信任客戶端 |
| **型別轉換** | 強制型別 |
| **長度限制** | 限制輸入長度 |

```python
# ✅ 白名單驗證
import re

def validate_username(username):
    # 只允許字母數字，3-20 字元
    pattern = r'^[a-zA-Z0-9]{3,20}$'
    if not re.match(pattern, username):
        raise ValueError("Invalid username")
    return username

def validate_email(email):
    # 使用驗證庫
    from email_validator import validate_email as ve
    return ve(email)
```

### 18.5.2 輸出編碼

```python
# ❌ 直接輸出 - XSS 風險
def render(user_input):
    return f"<div>{user_input}</div>"

# ✅ 編碼輸出
from html import escape

def render(user_input):
    return f"<div>{escape(user_input)}</div>"
```

### 18.5.3 密碼處理

```python
# ❌ 錯誤做法
def store_password(password):
    # 明文儲存 - 絕對不行！
    db.save(password)

    # MD5 - 太弱！
    import hashlib
    hashed = hashlib.md5(password.encode()).hexdigest()
    db.save(hashed)

# ✅ 正確做法
import bcrypt

def store_password(password):
    # 使用 bcrypt，自動加鹽
    hashed = bcrypt.hashpw(password.encode(), bcrypt.gensalt())
    db.save(hashed)

def verify_password(password, hashed):
    return bcrypt.checkpw(password.encode(), hashed)
```

### 18.5.4 敏感資料處理

| 資料類型 | 處理方式 |
|----------|----------|
| 密碼 | bcrypt/Argon2 雜湊 |
| 信用卡 | 不儲存，使用 Token |
| 個資 | 加密 + 存取控制 |
| API 金鑰 | 環境變數，不進版控 |

```python
# ❌ 硬編碼金鑰
API_KEY = "sk-12345abcde"

# ✅ 環境變數
import os
API_KEY = os.environ.get("API_KEY")
if not API_KEY:
    raise ValueError("API_KEY not configured")
```

---

## 18.6 安全測試

### 18.6.1 安全測試類型

| 類型 | 說明 | 工具 |
|------|------|------|
| **SAST** | 靜態程式碼分析 | SonarQube, Checkmarx |
| **DAST** | 動態應用測試 | OWASP ZAP, Burp |
| **IAST** | 互動式測試 | Contrast |
| **SCA** | 第三方元件分析 | Snyk, Dependabot |
| **滲透測試** | 人工攻擊模擬 | 安全專家 |

### 18.6.2 安全測試金字塔

```
                    ┌─────────────┐
                   ╱               ╲
                  ╱   滲透測試      ╲
                 ╱   (少量，人工)    ╲
                ╱─────────────────────╲
               ╱                       ╲
              ╱      DAST               ╲
             ╱     (自動化掃描)          ╲
            ╱───────────────────────────╲
           ╱                             ╲
          ╱          SAST + SCA           ╲
         ╱         (CI/CD 整合)            ╲
        ╱───────────────────────────────────╲
       ╱                                     ╲
      ╱            安全單元測試               ╲
     ╱           (開發者撰寫)                  ╲
    ╱───────────────────────────────────────────╲
```

### 18.6.3 安全測試整合到 CI/CD

```yaml
# .github/workflows/security.yml
name: Security Scan

on: [push, pull_request]

jobs:
  security:
    runs-on: ubuntu-latest
    steps:
      # SAST
      - name: Run SonarQube
        uses: sonarsource/sonarcloud-github-action@master

      # SCA
      - name: Run Snyk
        uses: snyk/actions/python@master
        with:
          command: test

      # Secrets scanning
      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
```

---

## 18.7 安全事件回應

### 18.7.1 事件回應流程

```
┌─────────────────────────────────────────────────────────────┐
│                   安全事件回應流程                           │
│                                                             │
│   ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐          │
│   │  偵測  │─►│  分析  │─►│  遏制  │─►│  根除  │          │
│   │        │  │        │  │        │  │        │          │
│   └────────┘  └────────┘  └────────┘  └────────┘          │
│                                              │               │
│                                              ▼               │
│                              ┌────────┐  ┌────────┐        │
│                              │  恢復  │─►│  學習  │        │
│                              │        │  │        │        │
│                              └────────┘  └────────┘        │
└─────────────────────────────────────────────────────────────┘
```

### 18.7.2 各階段活動

| 階段 | 活動 |
|------|------|
| **偵測** | 監控告警、日誌分析、使用者回報 |
| **分析** | 判斷影響範圍、嚴重程度 |
| **遏制** | 隔離受影響系統、阻止擴散 |
| **根除** | 移除惡意程式、修補漏洞 |
| **恢復** | 還原服務、驗證安全 |
| **學習** | 事後檢討、改善措施 |

---

## 18.8 本章總結

### 核心概念

| 概念 | 一句話解釋 |
|------|-----------|
| CIA | 機密性、完整性、可用性 |
| SDL | 在開發生命週期內建安全 |
| STRIDE | 六種威脅類型 |
| 威脅建模 | 系統性識別威脅 |
| 縱深防禦 | 多層防護 |

### 安全編碼 Checklist

| 項目 | 問題 |
|------|------|
| 輸入驗證 | 所有輸入都驗證了嗎？ |
| 輸出編碼 | 輸出有正確編碼嗎？ |
| 認證 | 認證機制安全嗎？ |
| 授權 | 每個請求都檢查權限嗎？ |
| 密碼 | 使用安全雜湊嗎？ |
| 敏感資料 | 有加密嗎？ |
| 日誌 | 有安全日誌嗎？ |
| 依賴 | 依賴有漏洞嗎？ |

### 下一章預告

安全是品質的一部分，測試是驗證品質的手段。下一章我們將學習「軟體測試——元件層級」——單元測試的策略和技術。

---

## 延伸思考

1. 你的專案做過威脅建模嗎？有哪些潛在威脅？

2. 你的 CI/CD 有安全掃描嗎？掃描什麼？

3. 如果發生安全事件，你們有應變計畫嗎？

---

*下一章：第19章　軟體測試——元件層級*
