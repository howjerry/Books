# 第 5 章：流量管理與非同步溝通 (Traffic & Messaging)

> 「黑色星期五不再是噩夢，而是我們展現實力的舞台。」
> —— CloudMart 技術長，2023 年

---

## 本章學習目標

完成本章後，你將能夠：

- 解釋負載平衡器的運作原理和演算法
- 設計高可用的多層負載平衡架構
- 理解 API Gateway 的角色和功能
- 說明訊息佇列如何實現非同步通訊
- 區分 Pub/Sub 和 Producer-Consumer 模式
- 在 Azure 上配置相關服務

---

## 5.1 流量洪峰：電商的生死關頭

經歷了 2022 年黑色星期五的慘痛教訓後，CloudMart 技術團隊痛定思痛，決定徹底重構系統架構。

他們設定了一個目標：

> **2023 年黑色星期五，系統必須能承受 10 倍於平日的流量，且不停機。**

要達成這個目標，需要解決三個核心問題：

```
┌─────────────────────────────────────────────────────────────────┐
│                    三大核心問題                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  問題 1：單點故障                                                │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  「一台伺服器掛掉，整個網站就下線了。」                     │ │
│  │                                                           │ │
│  │  解決方案：負載平衡 + 多副本                               │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  問題 2：流量不均                                                │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  「有些伺服器忙得要死，有些閒得發慌。」                     │ │
│  │                                                           │ │
│  │  解決方案：智能負載分配                                    │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  問題 3：同步阻塞                                                │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  「用戶下單後要等郵件發送完才能看到確認頁面。」             │ │
│  │                                                           │ │
│  │  解決方案：非同步訊息佇列                                  │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5.2 負載平衡：分散流量的藝術

### 5.2.1 什麼是負載平衡？

**負載平衡器（Load Balancer）** 是一個中間層，負責將入站流量分配到多個後端伺服器。

```
┌─────────────────────────────────────────────────────────────────┐
│                    負載平衡基本概念                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│                        沒有負載平衡                              │
│                                                                 │
│   用戶 1 ────┐                                                  │
│   用戶 2 ────┼──────────► 伺服器 A ◄── 負載 300%，快掛了        │
│   用戶 3 ────┘                                                  │
│                         伺服器 B ◄── 閒置中                     │
│                         伺服器 C ◄── 閒置中                     │
│                                                                 │
│  ════════════════════════════════════════════════════════════  │
│                                                                 │
│                        使用負載平衡                              │
│                                                                 │
│   用戶 1 ────┐         ┌────► 伺服器 A ◄── 負載 100%           │
│   用戶 2 ────┼── LB ───┼────► 伺服器 B ◄── 負載 100%           │
│   用戶 3 ────┘         └────► 伺服器 C ◄── 負載 100%           │
│                                                                 │
│  LB = Load Balancer（負載平衡器）                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2.2 負載平衡的好處

| 好處 | 說明 | CloudMart 效益 |
|------|------|---------------|
| **高可用性** | 一台伺服器故障，流量自動切換到其他伺服器 | 單台故障不影響服務 |
| **可擴展性** | 可以隨時增加或減少後端伺服器 | 黑五前增加伺服器 |
| **效能優化** | 將流量分配到最適合的伺服器 | 回應時間更穩定 |
| **維護友善** | 可以逐台更新伺服器而不中斷服務 | 零停機部署 |

### 5.2.3 負載平衡演算法

```
┌─────────────────────────────────────────────────────────────────┐
│                    負載平衡演算法比較                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 輪詢（Round Robin）                                         │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  請求 1 → Server A                                        │ │
│  │  請求 2 → Server B                                        │ │
│  │  請求 3 → Server C                                        │ │
│  │  請求 4 → Server A  (循環)                                │ │
│  │                                                           │ │
│  │  優點：簡單、公平                                          │ │
│  │  缺點：不考慮伺服器負載狀況                                │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  2. 加權輪詢（Weighted Round Robin）                            │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  Server A (權重 3)：請求 1, 2, 3                          │ │
│  │  Server B (權重 2)：請求 4, 5                             │ │
│  │  Server C (權重 1)：請求 6                                │ │
│  │                                                           │ │
│  │  優點：可以根據伺服器效能分配                              │ │
│  │  缺點：權重需要手動設定                                    │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  3. 最少連線（Least Connections）                               │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  Server A：目前 10 個連線                                 │ │
│  │  Server B：目前 5 個連線  ◄── 新請求送這裡                │ │
│  │  Server C：目前 8 個連線                                  │ │
│  │                                                           │ │
│  │  優點：動態平衡負載                                        │ │
│  │  缺點：不考慮連線的處理時間                                │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  4. IP 雜湊（IP Hash）                                          │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  用戶 IP: 192.168.1.100 → hash → Server A                │ │
│  │  用戶 IP: 192.168.1.101 → hash → Server B                │ │
│  │                                                           │ │
│  │  同一個用戶永遠被導向同一台伺服器（Session 親和性）        │ │
│  │                                                           │ │
│  │  優點：保持會話一致性                                      │ │
│  │  缺點：伺服器故障時會話丟失                                │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  5. 最短回應時間（Least Response Time）                         │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  Server A：平均回應 50ms                                  │ │
│  │  Server B：平均回應 30ms  ◄── 新請求送這裡                │ │
│  │  Server C：平均回應 45ms                                  │ │
│  │                                                           │ │
│  │  優點：用戶體驗最佳                                        │ │
│  │  缺點：需要持續監控回應時間                                │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2.4 L4 vs. L7 負載平衡

```
┌─────────────────────────────────────────────────────────────────┐
│                  L4 vs. L7 負載平衡                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  L4 負載平衡（傳輸層）                                           │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                                                           │ │
│  │  根據以下資訊做決策：                                      │ │
│  │  • 來源 IP 位址                                           │ │
│  │  • 目的 IP 位址                                           │ │
│  │  • 來源連接埠                                             │ │
│  │  • 目的連接埠                                             │ │
│  │                                                           │ │
│  │  特點：                                                    │ │
│  │  ✓ 速度快（不需解析內容）                                  │ │
│  │  ✓ 協定無關（TCP/UDP 都支援）                              │ │
│  │  ✗ 無法根據 URL 或標頭路由                                 │ │
│  │                                                           │ │
│  │  Azure 服務：Azure Load Balancer                          │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  L7 負載平衡（應用層）                                           │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                                                           │ │
│  │  根據以下資訊做決策：                                      │ │
│  │  • HTTP 標頭（Host, Cookie, Authorization）               │ │
│  │  • URL 路徑（/api/*, /static/*）                          │ │
│  │  • HTTP 方法（GET, POST）                                 │ │
│  │  • 請求內容                                               │ │
│  │                                                           │ │
│  │  特點：                                                    │ │
│  │  ✓ 智能路由（根據內容分流）                                │ │
│  │  ✓ SSL 終止（在 LB 處理加密）                              │ │
│  │  ✓ 內容快取                                               │ │
│  │  ✗ 較高的延遲和資源消耗                                    │ │
│  │                                                           │ │
│  │  Azure 服務：Application Gateway, Front Door              │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2.5 CloudMart 多層負載平衡架構

```
┌─────────────────────────────────────────────────────────────────┐
│                CloudMart 負載平衡架構                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│                         網際網路                                 │
│                            │                                    │
│                            ▼                                    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │               Azure Front Door (全球)                    │   │
│  │                                                         │   │
│  │  • 全球 Anycast                                         │   │
│  │  • SSL 終止                                             │   │
│  │  • WAF 防護                                             │   │
│  │  • 地理路由（亞洲用戶 → 亞洲區域）                        │   │
│  └─────────────────────────┬───────────────────────────────┘   │
│                            │                                    │
│            ┌───────────────┼───────────────┐                    │
│            │               │               │                    │
│            ▼               ▼               ▼                    │
│       東亞區域         美西區域        歐洲區域                  │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │            Azure Application Gateway (區域)              │   │
│  │                                                         │   │
│  │  • URL 路由                                             │   │
│  │  • 路徑規則：                                            │   │
│  │    /api/*     → API 服務池                              │   │
│  │    /static/*  → 靜態資源（重導到 CDN）                   │   │
│  │    /*         → Web 前端池                              │   │
│  └───────────┬─────────────────────────┬───────────────────┘   │
│              │                         │                        │
│              ▼                         ▼                        │
│  ┌───────────────────┐     ┌───────────────────┐               │
│  │  Azure Load       │     │  Azure Load       │               │
│  │  Balancer (L4)    │     │  Balancer (L4)    │               │
│  │  API 服務         │     │  Web 前端         │               │
│  └─────────┬─────────┘     └─────────┬─────────┘               │
│            │                         │                          │
│    ┌───────┼───────┐         ┌───────┼───────┐                  │
│    ▼       ▼       ▼         ▼       ▼       ▼                  │
│  ┌───┐   ┌───┐   ┌───┐     ┌───┐   ┌───┐   ┌───┐              │
│  │API│   │API│   │API│     │Web│   │Web│   │Web│              │
│  │ 1 │   │ 2 │   │ 3 │     │ 1 │   │ 2 │   │ 3 │              │
│  └───┘   └───┘   └───┘     └───┘   └───┘   └───┘              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5.3 API Gateway：微服務的統一入口

### 5.3.1 為什麼需要 API Gateway？

當 CloudMart 拆分為數十個微服務後，客戶端面臨新的問題：

```
┌─────────────────────────────────────────────────────────────────┐
│                  沒有 API Gateway 的問題                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  手機 App                                                       │
│       │                                                         │
│       ├── https://user.cloudmart.com/api/profile                │
│       ├── https://product.cloudmart.com/api/list                │
│       ├── https://order.cloudmart.com/api/history               │
│       ├── https://cart.cloudmart.com/api/items                  │
│       ├── https://payment.cloudmart.com/api/methods             │
│       └── https://notify.cloudmart.com/api/settings             │
│                                                                 │
│  問題：                                                          │
│  1. 客戶端需要知道所有服務的位址                                 │
│  2. 每個服務都需要處理認證                                       │
│  3. 無法統一限流和監控                                          │
│  4. 跨域問題（CORS）複雜                                        │
│  5. 服務變更影響所有客戶端                                       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.3.2 API Gateway 的角色

```
┌─────────────────────────────────────────────────────────────────┐
│                   API Gateway 架構                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  手機 App ──┐                                                   │
│  網頁 ──────┼──► https://api.cloudmart.com/* ─┐                 │
│  合作夥伴 ──┘                                 │                 │
│                                               ▼                 │
│                          ┌─────────────────────────────────┐   │
│                          │        API Gateway              │   │
│                          │                                 │   │
│                          │  ┌─────────────────────────┐   │   │
│                          │  │      認證與授權          │   │   │
│                          │  │  • JWT 驗證              │   │   │
│                          │  │  • API Key 驗證         │   │   │
│                          │  │  • OAuth 2.0            │   │   │
│                          │  └─────────────────────────┘   │   │
│                          │                                 │   │
│                          │  ┌─────────────────────────┐   │   │
│                          │  │      限流與配額          │   │   │
│                          │  │  • 每秒請求數限制        │   │   │
│                          │  │  • 每日配額              │   │   │
│                          │  │  • 用戶/IP 級別限制     │   │   │
│                          │  └─────────────────────────┘   │   │
│                          │                                 │   │
│                          │  ┌─────────────────────────┐   │   │
│                          │  │      請求路由            │   │   │
│                          │  │  /api/users/* → User    │   │   │
│                          │  │  /api/products/* → Prod │   │   │
│                          │  │  /api/orders/* → Order  │   │   │
│                          │  └─────────────────────────┘   │   │
│                          │                                 │   │
│                          │  ┌─────────────────────────┐   │   │
│                          │  │    請求/回應轉換         │   │   │
│                          │  │  • 標頭修改              │   │   │
│                          │  │  • 協定轉換              │   │   │
│                          │  │  • 資料格式轉換          │   │   │
│                          │  └─────────────────────────┘   │   │
│                          │                                 │   │
│                          │  ┌─────────────────────────┐   │   │
│                          │  │      監控與日誌          │   │   │
│                          │  │  • 請求追蹤              │   │   │
│                          │  │  • 效能指標              │   │   │
│                          │  │  • 錯誤追蹤              │   │   │
│                          │  └─────────────────────────┘   │   │
│                          │                                 │   │
│                          └──────────────┬──────────────────┘   │
│                                         │                       │
│               ┌─────────────────────────┼───────────────────┐   │
│               │                         │                   │   │
│               ▼                         ▼                   ▼   │
│         User Service            Product Service       Order Svc │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.3.3 Azure API Management 設定

```xml
<!-- Azure APIM 政策範例 -->
<policies>
    <inbound>
        <!-- 驗證 JWT Token -->
        <validate-jwt header-name="Authorization"
                      failed-validation-httpcode="401"
                      failed-validation-error-message="Unauthorized">
            <openid-config url="https://login.microsoftonline.com/{tenant}/.well-known/openid-configuration" />
            <required-claims>
                <claim name="aud" match="all">
                    <value>api://cloudmart</value>
                </claim>
            </required-claims>
        </validate-jwt>

        <!-- 限流：每分鐘 100 次請求 -->
        <rate-limit-by-key calls="100"
                          renewal-period="60"
                          counter-key="@(context.Subscription.Id)" />

        <!-- 配額：每天 10000 次請求 -->
        <quota-by-key calls="10000"
                      renewal-period="86400"
                      counter-key="@(context.Subscription.Id)" />

        <!-- 設定後端服務位址 -->
        <set-backend-service base-url="https://order-service.internal.cloudmart.com" />

        <!-- 添加追蹤標頭 -->
        <set-header name="X-Request-ID" exists-action="skip">
            <value>@(Guid.NewGuid().ToString())</value>
        </set-header>
    </inbound>

    <backend>
        <forward-request />
    </backend>

    <outbound>
        <!-- 移除敏感標頭 -->
        <set-header name="X-Powered-By" exists-action="delete" />
        <set-header name="Server" exists-action="delete" />

        <!-- 添加 CORS 標頭 -->
        <cors allow-credentials="true">
            <allowed-origins>
                <origin>https://www.cloudmart.com</origin>
                <origin>https://admin.cloudmart.com</origin>
            </allowed-origins>
            <allowed-methods>
                <method>GET</method>
                <method>POST</method>
                <method>PUT</method>
                <method>DELETE</method>
            </allowed-methods>
        </cors>
    </outbound>

    <on-error>
        <!-- 統一錯誤回應格式 -->
        <set-body>@{
            return new JObject(
                new JProperty("error", context.LastError.Message),
                new JProperty("requestId", context.RequestId)
            ).ToString();
        }</set-body>
    </on-error>
</policies>
```

---

## 5.4 訊息佇列：非同步通訊的橋樑

### 5.4.1 同步 vs. 非同步通訊

```
┌─────────────────────────────────────────────────────────────────┐
│                同步 vs. 非同步通訊                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  同步通訊（Synchronous）                                        │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                                                           │ │
│  │  用戶 ──► Order Service ──► Payment Service               │ │
│  │    │              │                │                      │ │
│  │    │              │                │                      │ │
│  │    │              │◄───────────────┘ 等待回應              │ │
│  │    │◄─────────────┘ 等待回應                              │ │
│  │    │                                                      │ │
│  │    ▼ 終於收到回應（總時間 = 所有服務時間之和）              │ │
│  │                                                           │ │
│  │  問題：                                                    │ │
│  │  • 用戶必須等待所有服務完成                                │ │
│  │  • 任一服務故障導致整個請求失敗                            │ │
│  │  • 無法處理流量尖峰                                        │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  非同步通訊（Asynchronous）                                     │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                                                           │ │
│  │  用戶 ──► Order Service ──► Message Queue                 │ │
│  │    │              │              │                        │ │
│  │    │◄─────────────┘              │ 訊息放入佇列           │ │
│  │    │                             │                        │ │
│  │    ▼ 立即收到回應                │                        │ │
│  │      "訂單已受理"                ▼                        │ │
│  │                           Payment Service                 │ │
│  │                           （稍後處理）                     │ │
│  │                                  │                        │ │
│  │                                  ▼                        │ │
│  │                           Notification Service            │ │
│  │                           （發送確認信）                   │ │
│  │                                                           │ │
│  │  優點：                                                    │ │
│  │  • 用戶快速收到回應                                        │ │
│  │  • 服務故障不影響用戶體驗                                  │ │
│  │  • 可以緩衝流量尖峰                                        │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.4.2 訊息佇列的核心概念

```
┌─────────────────────────────────────────────────────────────────┐
│                訊息佇列核心概念                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Producer（生產者）                                              │
│  ┌─────────────┐                                                │
│  │ Order Svc   │ ─── 產生訊息 ───►                             │
│  └─────────────┘                                                │
│                                                                 │
│  Message Queue（訊息佇列）                                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐               │   │
│  │ │ M5  │ │ M4  │ │ M3  │ │ M2  │ │ M1  │ ─────────────► │   │
│  │ └─────┘ └─────┘ └─────┘ └─────┘ └─────┘    FIFO        │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  Consumer（消費者）                                              │
│  ┌─────────────┐                                                │
│  │ Email Svc   │ ◄─── 取出訊息 ───                             │
│  └─────────────┘                                                │
│                                                                 │
│  ═══════════════════════════════════════════════════════════   │
│                                                                 │
│  關鍵特性：                                                      │
│                                                                 │
│  1. 解耦（Decoupling）                                          │
│     生產者和消費者不需要同時在線                                 │
│                                                                 │
│  2. 緩衝（Buffering）                                           │
│     流量尖峰時，訊息暫存在佇列中                                 │
│                                                                 │
│  3. 可靠傳遞（Reliable Delivery）                               │
│     訊息會被持久化，確保不會丟失                                 │
│                                                                 │
│  4. 擴展性（Scalability）                                       │
│     可以增加多個消費者並行處理                                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.4.3 點對點 vs. 發布/訂閱

```
┌─────────────────────────────────────────────────────────────────┐
│             兩種訊息傳遞模式                                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  點對點（Point-to-Point / Queue）                               │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                                                           │ │
│  │  Producer ──► Queue ──► Consumer                          │ │
│  │                                                           │ │
│  │  特點：                                                    │ │
│  │  • 一個訊息只被一個消費者處理                              │ │
│  │  • 多個消費者時，負載平衡分配                              │ │
│  │                                                           │ │
│  │  適用場景：                                                │ │
│  │  • 任務分配（每個任務只需處理一次）                        │ │
│  │  • 工作佇列（多個 Worker 並行處理）                        │ │
│  │                                                           │ │
│  │  CloudMart 範例：                                          │ │
│  │  訂單處理佇列 → 多個訂單處理 Worker                        │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  發布/訂閱（Publish/Subscribe / Topic）                         │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                                                           │ │
│  │                    ┌──► Subscriber A（庫存服務）           │ │
│  │  Publisher ──► Topic ──► Subscriber B（通知服務）          │ │
│  │                    └──► Subscriber C（分析服務）           │ │
│  │                                                           │ │
│  │  特點：                                                    │ │
│  │  • 一個訊息被所有訂閱者接收                                │ │
│  │  • 訂閱者可以動態加入/離開                                 │ │
│  │                                                           │ │
│  │  適用場景：                                                │ │
│  │  • 事件廣播（多個服務需要知道同一事件）                    │ │
│  │  • 日誌收集（多個系統訂閱日誌）                            │ │
│  │                                                           │ │
│  │  CloudMart 範例：                                          │ │
│  │  "訂單已建立" 事件 → 庫存扣減、發送郵件、數據分析           │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.4.4 CloudMart 訊息架構

```
┌─────────────────────────────────────────────────────────────────┐
│                CloudMart 訊息架構                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│                                                                 │
│  ┌─────────────┐                                                │
│  │ Order       │                                                │
│  │ Service     │                                                │
│  └──────┬──────┘                                                │
│         │                                                       │
│         │ 發布 "OrderCreated" 事件                               │
│         ▼                                                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                Azure Service Bus Topic                   │   │
│  │                    "order-events"                        │   │
│  └──────────────────────┬──────────────────────────────────┘   │
│                         │                                       │
│         ┌───────────────┼───────────────┬───────────────┐       │
│         │               │               │               │       │
│         ▼               ▼               ▼               ▼       │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌───────────┐ │
│  │ Inventory   │ │ Payment     │ │ Notification│ │ Analytics │ │
│  │ Subscription│ │ Subscription│ │ Subscription│ │ Subscript.│ │
│  └──────┬──────┘ └──────┬──────┘ └──────┬──────┘ └─────┬─────┘ │
│         │               │               │               │       │
│         ▼               ▼               ▼               ▼       │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌───────────┐ │
│  │ Inventory   │ │ Payment     │ │ Email       │ │ Analytics │ │
│  │ Service     │ │ Service     │ │ Service     │ │ Service   │ │
│  │             │ │             │ │             │ │           │ │
│  │ 扣減庫存    │ │ 處理付款    │ │ 發送確認信  │ │ 記錄數據  │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └───────────┘ │
│                                                                 │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                   Azure Service Bus Queue                │   │
│  │                   "email-queue"                          │   │
│  └──────────────────────┬──────────────────────────────────┘   │
│                         │                                       │
│         ┌───────────────┼───────────────┐                       │
│         ▼               ▼               ▼                       │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐               │
│  │ Email       │ │ Email       │ │ Email       │               │
│  │ Worker 1    │ │ Worker 2    │ │ Worker 3    │               │
│  │             │ │             │ │             │               │
│  │ 處理郵件 A  │ │ 處理郵件 B  │ │ 處理郵件 C  │               │
│  └─────────────┘ └─────────────┘ └─────────────┘               │
│                                                                 │
│  點對點：每封郵件只被一個 Worker 處理                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.4.5 實作範例：使用 Azure Service Bus

```javascript
// order-service.js - 發布訂單事件

const { ServiceBusClient } = require("@azure/service-bus");

class OrderEventPublisher {
    constructor(connectionString) {
        this.client = new ServiceBusClient(connectionString);
        this.sender = this.client.createSender("order-events");
    }

    async publishOrderCreated(order) {
        const message = {
            body: {
                eventType: "OrderCreated",
                timestamp: new Date().toISOString(),
                data: {
                    orderId: order.id,
                    customerId: order.customerId,
                    items: order.items,
                    totalAmount: order.totalAmount
                }
            },
            contentType: "application/json",
            // 用於過濾的屬性
            applicationProperties: {
                eventType: "OrderCreated",
                priority: order.totalAmount > 10000 ? "high" : "normal"
            }
        };

        await this.sender.sendMessages(message);
        console.log(`Published OrderCreated event for order ${order.id}`);
    }

    async close() {
        await this.sender.close();
        await this.client.close();
    }
}

// 使用範例
async function createOrder(orderData) {
    // 1. 儲存訂單到資料庫
    const order = await orderRepository.save(orderData);

    // 2. 發布事件（非同步，不阻塞）
    const publisher = new OrderEventPublisher(process.env.SERVICE_BUS_CONNECTION);
    await publisher.publishOrderCreated(order);
    await publisher.close();

    // 3. 立即回應用戶
    return {
        success: true,
        orderId: order.id,
        message: "訂單已受理，我們會發送確認郵件給您"
    };
}
```

```javascript
// inventory-service.js - 訂閱訂單事件

const { ServiceBusClient } = require("@azure/service-bus");

class InventoryEventSubscriber {
    constructor(connectionString) {
        this.client = new ServiceBusClient(connectionString);
        this.receiver = this.client.createReceiver(
            "order-events",           // Topic 名稱
            "inventory-subscription"  // Subscription 名稱
        );
    }

    async startListening() {
        const messageHandler = async (message) => {
            const event = message.body;
            console.log(`Received event: ${event.eventType}`);

            if (event.eventType === "OrderCreated") {
                await this.handleOrderCreated(event.data);
            }
        };

        const errorHandler = async (error) => {
            console.error("Error receiving message:", error);
        };

        this.receiver.subscribe({
            processMessage: messageHandler,
            processError: errorHandler
        });

        console.log("Inventory service listening for order events...");
    }

    async handleOrderCreated(orderData) {
        // 扣減庫存
        for (const item of orderData.items) {
            await inventoryRepository.decreaseStock(
                item.productId,
                item.quantity
            );
            console.log(`Decreased stock for product ${item.productId}`);
        }
    }

    async close() {
        await this.receiver.close();
        await this.client.close();
    }
}

// 啟動服務
const subscriber = new InventoryEventSubscriber(
    process.env.SERVICE_BUS_CONNECTION
);
subscriber.startListening();
```

---

## 5.5 流量控制策略

### 5.5.1 限流（Rate Limiting）

```
┌─────────────────────────────────────────────────────────────────┐
│                    限流策略                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 固定窗口（Fixed Window）                                     │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                                                           │ │
│  │  每分鐘限制 100 次請求                                     │ │
│  │                                                           │ │
│  │  時間軸：                                                  │ │
│  │  [00:00 - 01:00]  [01:00 - 02:00]  [02:00 - 03:00]        │ │
│  │     100 次           100 次           100 次              │ │
│  │                                                           │ │
│  │  問題：邊界突發                                            │ │
│  │  [00:59] 100 次 + [01:00] 100 次 = 2秒內 200 次           │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  2. 滑動窗口（Sliding Window）                                   │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                                                           │ │
│  │  過去 60 秒內限制 100 次請求                               │ │
│  │                                                           │ │
│  │  時間軸（滑動）：                                          │ │
│  │  ├─────────60秒─────────┤                                 │ │
│  │     ├─────────60秒─────────┤                              │ │
│  │        ├─────────60秒─────────┤                           │ │
│  │                                                           │ │
│  │  優點：更平滑的限流                                        │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  3. 令牌桶（Token Bucket）                                       │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                                                           │ │
│  │  ┌─────────┐ 每秒補充 10 個令牌                           │ │
│  │  │ ○ ○ ○ ○ │ ◄───────────────────                        │ │
│  │  │ ○ ○ ○ ○ │ 桶容量：100                                  │ │
│  │  │ ○ ○ ○ ○ │                                              │ │
│  │  └────┬────┘                                              │ │
│  │       │ 每個請求消耗 1 個令牌                              │ │
│  │       ▼                                                   │ │
│  │    [請求]                                                 │ │
│  │                                                           │ │
│  │  優點：允許短期突發（使用累積的令牌）                      │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.5.2 熔斷器模式（Circuit Breaker）

```
┌─────────────────────────────────────────────────────────────────┐
│                    熔斷器模式                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  狀態轉換：                                                      │
│                                                                 │
│       ┌──────────────────────────────────────────┐              │
│       │                                          │              │
│       ▼                                          │              │
│  ┌─────────┐    失敗達到閾值    ┌─────────┐      │              │
│  │  關閉   │ ─────────────────► │  開啟   │      │              │
│  │ CLOSED  │                    │  OPEN   │      │              │
│  └────┬────┘                    └────┬────┘      │              │
│       │                              │           │              │
│       │ 請求正常                     │ 等待超時  │              │
│       │                              │           │              │
│       │                              ▼           │              │
│       │                        ┌──────────┐     │              │
│       │                        │  半開    │     │              │
│       │                        │HALF-OPEN │     │              │
│       │                        └────┬─────┘     │              │
│       │                             │           │              │
│       │      請求成功               │ 請求失敗  │              │
│       └─────────────────────────────┴───────────┘              │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  狀態說明：                                                │ │
│  │                                                           │ │
│  │  CLOSED（關閉）：正常狀態，請求正常通過                    │ │
│  │  OPEN（開啟）：熔斷狀態，直接拒絕請求，快速失敗            │ │
│  │  HALF-OPEN（半開）：嘗試狀態，放行少量請求測試             │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  CloudMart 範例：                                                │
│  當支付服務連續失敗 5 次後，熔斷器開啟，                         │
│  直接回傳「支付服務暫時不可用，請稍後再試」                      │
│  而不是讓用戶等待超時                                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5.6 章節總結

### 核心概念回顧

| 概念 | 說明 | Azure 服務 |
|------|------|-----------|
| **L4 負載平衡** | 基於 IP/Port 分流 | Azure Load Balancer |
| **L7 負載平衡** | 基於 HTTP 內容分流 | Application Gateway |
| **API Gateway** | 統一入口、認證、限流 | Azure API Management |
| **訊息佇列** | 非同步點對點通訊 | Service Bus Queue |
| **發布/訂閱** | 事件廣播 | Service Bus Topic |
| **限流** | 控制請求速率 | API Management 政策 |
| **熔斷器** | 快速失敗保護 | 應用程式實作 |

### AZ-900 考試重點

1. **負載平衡類型**：知道 L4 和 L7 的差異
2. **Azure 負載平衡服務**：Load Balancer vs. Application Gateway vs. Front Door
3. **訊息服務**：Service Bus Queue vs. Topic
4. **Event Grid vs. Service Bus**：知道何時使用哪個

### 學習檢查清單

完成本章後，請確認你可以：

- [ ] 解釋不同負載平衡演算法的特點
- [ ] 設計多層負載平衡架構
- [ ] 說明 API Gateway 的核心功能
- [ ] 區分點對點和發布/訂閱模式
- [ ] 使用 Azure Service Bus 實作訊息傳遞
- [ ] 解釋熔斷器模式的作用

---

## 5.7 下一章預告

在下一章「事件驅動與自動化」中，我們將探討：

- 什麼是事件驅動架構？
- Webhook 如何實現系統間的即時通知？
- 無伺服器運算如何簡化事件處理？
- 如何使用 Azure Functions 建立事件驅動應用？

---

**上一章：[第 4 章：解構單體架構](./chapter-04.md)**

**下一章：[第 6 章：事件驅動與自動化](./chapter-06.md)**
