# ç¬¬ 4 ç« ï¼šæ ¸å¿ƒèª¿åº¦å™¨è¨­è¨ˆ - ç¨‹å¼ç¢¼ç¯„ä¾‹

> æœ¬ç›®éŒ„åŒ…å«ã€Šæ·±åº¦ç ”ç©¶ä»£ç†äººå¯¦æˆ°ã€‹ç¬¬ 4 ç« çš„å®Œæ•´å¯é‹è¡Œç¨‹å¼ç¢¼ã€‚

---

## å¿«é€Ÿé–‹å§‹

### 1. å»ºç«‹è™›æ“¬ç’°å¢ƒ

```bash
cd code-examples/chapter-04
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
```

### 2. å®‰è£ä¾è³´

```bash
pip install -r requirements.txt
```

### 3. è¨­å®šç’°å¢ƒè®Šæ•¸

```bash
cp .env.example .env
# ç·¨è¼¯ .env æª”æ¡ˆï¼Œå¡«å…¥ä½ çš„ API Key
```

### 4. åŸ·è¡Œ

```bash
# åŸ·è¡Œç¤ºç¯„
python dispatcher.py

# æŒ‡å®šç ”ç©¶å•é¡Œ
python dispatcher.py -q "åˆ†æé›»å‹•è»Šç”¢æ¥­çš„ç™¼å±•è¶¨å‹¢"

# èª¿æ•´ä¸¦ç™¼æ•¸
python dispatcher.py -q "AI æ™¶ç‰‡å¸‚å ´åˆ†æ" --max-concurrent 3

# è¼¸å‡ºåˆ°æª”æ¡ˆ
python dispatcher.py -q "é‡å­è¨ˆç®—çš„å•†æ¥­æ‡‰ç”¨" -o report.md
```

---

## æª”æ¡ˆèªªæ˜

| æª”æ¡ˆ | èªªæ˜ |
|------|------|
| `dispatcher.py` | å®Œæ•´çš„èª¿åº¦å™¨å¯¦ç¾ï¼ˆ~550 è¡Œï¼‰ |
| `requirements.txt` | Python ä¾è³´æ¸…å–® |
| `.env.example` | ç’°å¢ƒè®Šæ•¸ç¯„ä¾‹ |
| `README.md` | æœ¬æ–‡ä»¶ |

---

## æ ¸å¿ƒæ¦‚å¿µ

### èª¿åº¦å™¨æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Dispatcher                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚TaskDecomposerâ”‚  â”‚TaskExecutor â”‚  â”‚ EventBus   â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              DependencyGraph                     â”‚   â”‚
â”‚  â”‚  - ç®¡ç†ä»»å‹™ä¾è³´é—œä¿‚                              â”‚   â”‚
â”‚  â”‚  - æ‹“æ’²æ’åºç²å–åŸ·è¡Œé †åº                          â”‚   â”‚
â”‚  â”‚  - è­˜åˆ¥å¯åŸ·è¡Œä»»å‹™                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä»»å‹™ç‹€æ…‹æ©Ÿ

```
PENDING â†’ PLANNING â†’ READY â†’ RUNNING â†’ COMPLETED
                         â†“         â†“
                      WAITING   FAILED
                         â†“
                      RETRYING â†’ RUNNING
```

### ä»»å‹™åˆ†è§£æµç¨‹

```
åŸå§‹ä»»å‹™
    â†“
TaskDecomposer.decompose()
    â†“
[å­ä»»å‹™1, å­ä»»å‹™2, å­ä»»å‹™3, ..., æœ€çµ‚æ•´åˆä»»å‹™]
    â†“
DependencyGraph.add_task() Ã— N
    â†“
DependencyGraph.get_execution_order()
    â†“
ä¸¦è¡ŒåŸ·è¡Œ (å— max_concurrent é™åˆ¶)
```

---

## ä½¿ç”¨ç¯„ä¾‹

### åŸºæœ¬ç”¨æ³•

```python
import asyncio
from dispatcher import Dispatcher

async def main():
    dispatcher = Dispatcher(
        model="gpt-4o-mini",
        max_concurrent=5,
        verbose=True
    )

    result = await dispatcher.run(
        "åˆ†æ 2024 å¹´å…¨çƒ AI æ™¶ç‰‡å¸‚å ´æ ¼å±€"
    )

    print(result["content"])

asyncio.run(main())
```

### è‡ªè¨‚é…ç½®

```python
from dispatcher import Dispatcher, TaskExecutor, TaskDecomposer

# ä½¿ç”¨æ›´å¼·å¤§çš„æ¨¡å‹
dispatcher = Dispatcher(
    model="gpt-4o",
    max_concurrent=3,
    task_timeout=600.0
)
```

### äº‹ä»¶ç›£è½

```python
from dispatcher import Dispatcher, TaskEvent

dispatcher = Dispatcher()

# ç›£è½ä»»å‹™å®Œæˆäº‹ä»¶
dispatcher.event_bus.subscribe(
    TaskEvent.COMPLETED,
    lambda data: print(f"ä»»å‹™ {data['task_id']} å®Œæˆï¼")
)

# ç›£è½å¤±æ•—äº‹ä»¶
dispatcher.event_bus.subscribe(
    TaskEvent.FAILED,
    lambda data: send_alert(data['error'])
)
```

---

## åŸ·è¡Œç¯„ä¾‹

```
============================================================
ğŸš€ é–‹å§‹èª¿åº¦ï¼šåˆ†æ 2024 å¹´å…¨çƒ AI æ™¶ç‰‡å¸‚å ´æ ¼å±€
============================================================

ğŸ“‹ è¦åŠƒä»»å‹™ï¼šåˆ†æ 2024 å¹´å…¨çƒ AI æ™¶ç‰‡å¸‚å ´æ ¼å±€...
   ğŸ“Š åˆ†è§£ç‚º 5 å€‹å­ä»»å‹™
   ğŸ“ åŸ·è¡Œé †åºï¼šabc123-1 â†’ abc123-2 â†’ abc123-3 â†’ abc123-4 â†’ abc123-final

ğŸ“ é–‹å§‹åŸ·è¡Œä»»å‹™

   ğŸ”„ ä¸¦è¡ŒåŸ·è¡Œ 3 å€‹ä»»å‹™
      âœ… abc123-1: å®Œæˆ
      âœ… abc123-2: å®Œæˆ
      âœ… abc123-3: å®Œæˆ

   ğŸ”„ ä¸¦è¡ŒåŸ·è¡Œ 1 å€‹ä»»å‹™
      âœ… abc123-4: å®Œæˆ

   ğŸ”„ ä¸¦è¡ŒåŸ·è¡Œ 1 å€‹ä»»å‹™
      âœ… abc123-final: å®Œæˆ

============================================================
âœ… èª¿åº¦å®Œæˆ

   ğŸ“Š åŸ·è¡Œçµ±è¨ˆ
   â”œâ”€â”€ ç¸½ä»»å‹™æ•¸ï¼š5
   â”œâ”€â”€ å®Œæˆä»»å‹™ï¼š5
   â”œâ”€â”€ å¤±æ•—ä»»å‹™ï¼š0
   â”œâ”€â”€ ç¸½é‡è©¦æ¬¡æ•¸ï¼š0
   â””â”€â”€ ç¸½è€—æ™‚ï¼š28.3 ç§’
============================================================
```

---

## é€²éšåŠŸèƒ½

### æŸ¥çœ‹ä»»å‹™æ¨¹

```python
tree = dispatcher.get_task_tree()
print(json.dumps(tree, indent=2, ensure_ascii=False))
```

è¼¸å‡ºï¼š
```json
{
  "id": "abc123",
  "query": "åˆ†æ 2024 å¹´å…¨çƒ AI æ™¶ç‰‡å¸‚å ´æ ¼å±€...",
  "state": "WAITING",
  "children": [
    {"id": "abc123-1", "query": "å¸‚å ´è¦æ¨¡ç ”ç©¶...", "state": "COMPLETED"},
    {"id": "abc123-2", "query": "ä¸»è¦ç©å®¶åˆ†æ...", "state": "COMPLETED"},
    {"id": "abc123-final", "query": "æ•´åˆç ”ç©¶çµæœ...", "state": "COMPLETED"}
  ]
}
```

### è‡ªè¨‚ä»»å‹™åŸ·è¡Œå™¨

```python
from dispatcher import TaskExecutor, Task

class CustomExecutor(TaskExecutor):
    async def _execute_search(self, task: Task) -> dict:
        # ä½¿ç”¨çœŸå¯¦çš„æœå°‹ API
        results = await my_search_api.search(task.query)
        return {"type": "search", "content": results}

dispatcher.executor = CustomExecutor(dispatcher.client)
```

### ä»»å‹™æŒä¹…åŒ–

```python
# ä¿å­˜ä»»å‹™ç‹€æ…‹
def save_tasks():
    with open('tasks.json', 'w') as f:
        json.dump({
            tid: task.to_dict()
            for tid, task in dispatcher.tasks.items()
        }, f)

# è¨‚é–±äº‹ä»¶è‡ªå‹•ä¿å­˜
dispatcher.event_bus.subscribe(TaskEvent.COMPLETED, lambda _: save_tasks())
```

---

## éŒ¯èª¤è™•ç†

### é‡è©¦æ©Ÿåˆ¶

èª¿åº¦å™¨å…§å»ºæŒ‡æ•¸é€€é¿é‡è©¦æ©Ÿåˆ¶ï¼š

| é‡è©¦æ¬¡æ•¸ | ç­‰å¾…æ™‚é–“ |
|----------|----------|
| 1 | 2 ç§’ |
| 2 | 4 ç§’ |
| 3 | 8 ç§’ |
| 4+ | æ¨™è¨˜å¤±æ•— |

### ä¾è³´å¤±æ•—è™•ç†

ç•¶å­ä»»å‹™å¤±æ•—æ™‚ï¼š
1. ä¾è³´è©²ä»»å‹™çš„å¾ŒçºŒä»»å‹™ç„¡æ³•åŸ·è¡Œ
2. èª¿åº¦å™¨æœƒè¨˜éŒ„å¤±æ•—åŸå› 
3. æœ€çµ‚çµæœæœƒæ¨™è¨˜ `success: false`

---

## å¸¸è¦‹å•é¡Œ

### Q: ä»»å‹™åˆ†è§£ä¸å¤ ç´°æ€éº¼è¾¦ï¼Ÿ

èª¿æ•´ `TaskDecomposer` çš„ promptï¼Œæˆ–å¢åŠ åˆ†è§£æ·±åº¦ã€‚

### Q: ä¸¦ç™¼æ•¸è¨­å¤šå°‘åˆé©ï¼Ÿ

å»ºè­°ï¼š
- API æœ‰ rate limitï¼šè¨­ 3-5
- ç„¡é™åˆ¶ï¼šè¨­ 10-15
- è¦è€ƒæ…®æˆæœ¬ï¼šè¨­ 1-3

### Q: å¦‚ä½•è™•ç†è¶…é•·ä»»å‹™ï¼Ÿ

1. å¢åŠ  `task_timeout`
2. å°‡ä»»å‹™åˆ†è§£ç‚ºæ›´å°çš„å­ä»»å‹™
3. ä½¿ç”¨æµå¼éŸ¿æ‡‰

---

## å»¶ä¼¸é–±è®€

- [ç¬¬ 1-3 ç« ç¨‹å¼ç¢¼](../) - ç†è«–åŸºç¤
- [ç¬¬ 5 ç« ç¨‹å¼ç¢¼](../chapter-05/) - å·¥å…·èª¿ç”¨èˆ‡è»Œè·¡æ”¶é›†
- [asyncio å®˜æ–¹æ–‡æª”](https://docs.python.org/3/library/asyncio.html)

---

**æœ¬ç« ç¨‹å¼ç¢¼æˆæ¬Š**ï¼šMIT License
